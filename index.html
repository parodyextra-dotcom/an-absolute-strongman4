<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì ˆëŒ€ê°•ì ê°€ê³„ë¶€</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="max-w-md mx-auto bg-gray-50 min-h-screen pb-20"></div>

  <script>
    // State Management
    const state = {
      activeTab: 'home',
      transactions: [],
      memos: [],
      events: [],
      goals: { year7: '', year5: '', year3: '', thisYear: '' },
      bankBalances: [],
      categories: {
        expense: ['ì‹ë¹„', 'êµí†µë¹„', 'í†µì‹ ë¹„', 'ìƒí™œìš©í’ˆ', 'ì˜ë£Œë¹„', 'êµìœ¡ë¹„', 'ë¬¸í™”ìƒí™œ', 'ì•„ë²„ì§€', 'ì§€í™˜', 'ë‹¤í˜œ', 'ë‹¤ì—°', 'ë³´í—˜ë£Œ', 'ì™¸ì‹ë¹„', 'ì„¸ê¸ˆê³µê³¼ê¸ˆ', 'ì£¼ìœ ë¹„', 'ê¸°íƒ€ë¹„'],
        income: ['ê¸‰ì—¬', 'ì´ì', 'ëŒ€ë¦¬ì—…ë¬´', 'ë°°ë‹¹ê¸ˆ', 'ê¸°íƒ€ìˆ˜ì…']
      },
      undoStack: [],
      showAddTransaction: false,
      showCompoundCalc: false,
      showSettings: false,
      isLoading: true
    };

    // Storage helpers
    const storage = {
      get: (key) => {
        try {
          const value = localStorage.getItem(key);
          return value ? JSON.parse(value) : null;
        } catch { return null; }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) { console.error('Storage error:', e); }
      }
    };

    // Load data
    function loadData() {
      state.transactions = storage.get('transactions') || [];
      state.memos = storage.get('memos') || [];
      state.events = storage.get('events') || [];
      state.goals = storage.get('goals') || { year7: '', year5: '', year3: '', thisYear: '' };
      state.bankBalances = storage.get('bankBalances') || [];
      state.categories = storage.get('categories') || state.categories;
      state.isLoading = false;
      render();
    }

    // Save data
    function saveData() {
      storage.set('transactions', state.transactions);
      storage.set('memos', state.memos);
      storage.set('events', state.events);
      storage.set('goals', state.goals);
      storage.set('bankBalances', state.bankBalances);
      storage.set('categories', state.categories);
    }

    // Toast notification
    let toastTimeout;
    function showToast(message, type = 'success') {
      const existing = document.getElementById('toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-500' : 'bg-green-500'
      } text-white font-medium animate-fade-in`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toast.remove(), 3000);
    }

    // Utility functions
    function formatNumber(num) {
      return num.toLocaleString();
    }

    function getRankInfo(balance) {
      if (balance >= 500000000) return { rank: 'ì ˆëŒ€ê°•ì', color: 'text-purple-600', bgColor: 'bg-purple-100', icon: 'ğŸ‘‘' };
      if (balance >= 200000000) return { rank: 'ì†Œë¶€ì', color: 'text-blue-600', bgColor: 'bg-blue-100', icon: 'ğŸ’' };
      if (balance >= 100000000) return { rank: 'ì¤‘ì‚°ì¸µ', color: 'text-green-600', bgColor: 'bg-green-100', icon: 'ğŸ†' };
      if (balance >= 50000000) return { rank: 'ì„œë¯¼', color: 'text-yellow-600', bgColor: 'bg-yellow-100', icon: 'â­' };
      if (balance >= 10000000) return { rank: 'ì°¨ìƒìœ„ì', color: 'text-orange-600', bgColor: 'bg-orange-100', icon: 'ğŸ”¶' };
      return { rank: 'ê¸°ì´ˆìˆ˜ê¸‰ì', color: 'text-gray-600', bgColor: 'bg-gray-100', icon: 'ğŸŒ±' };
    }

    function addToUndoStack(action, data) {
      state.undoStack.push({ action, data, timestamp: Date.now() });
      if (state.undoStack.length > 10) state.undoStack.shift();
    }

    function handleUndo() {
      if (state.undoStack.length === 0) return;
      const lastAction = state.undoStack.pop();
      
      if (lastAction.action === 'deleteTransaction') {
        state.transactions.push(lastAction.data);
        showToast('ê±°ë˜ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
      } else if (lastAction.action === 'deleteMemo') {
        state.memos.push(lastAction.data);
        showToast('ë©”ëª¨ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
      }
      saveData();
      render();
    }

    // Export functions
    function exportData() {
      const data = {
        transactions: state.transactions,
        memos: state.memos,
        goals: state.goals,
        bankBalances: state.bankBalances,
        events: state.events,
        categories: state.categories,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `budget_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      showToast('ë°ì´í„°ê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function exportToCSV() {
      const headers = ['ë‚ ì§œ', 'ìœ í˜•', 'ì¹´í…Œê³ ë¦¬', 'ê¸ˆì•¡', 'ê²°ì œìˆ˜ë‹¨', 'í• ë¶€', 'í•„ìš”ì§€ì¶œ', 'ë©”ëª¨'];
      const rows = state.transactions.map(t => [
        t.date,
        t.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ',
        t.category,
        t.amount,
        t.paymentMethod === 'card' ? 'ì¹´ë“œ' : 'í˜„ê¸ˆ',
        t.installment || 'ì¼ì‹œë¶ˆ',
        t.isNecessary ? 'í•„ìš”' : 'ë¶ˆí•„ìš”',
        t.memo || ''
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');

      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `ê±°ë˜ë‚´ì—­_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
      showToast('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.transactions || !Array.isArray(data.transactions)) {
            throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹');
          }

          if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            state.transactions = data.transactions || [];
            state.memos = data.memos || [];
            state.goals = data.goals || { year7: '', year5: '', year3: '', thisYear: '' };
            state.bankBalances = data.bankBalances || [];
            state.events = data.events || [];
            if (data.categories) state.categories = data.categories;
            saveData();
            render();
            showToast('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤');
          }
        } catch (error) {
          showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Render functions
    function renderHeader() {
      const totalBankBalance = state.bankBalances.reduce((sum, b) => sum + b.balance, 0);
      const rankInfo = getRankInfo(totalBankBalance);
      
      return `
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 sticky top-0 z-10 shadow-lg">
          <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold">ì ˆëŒ€ê°•ì ê°€ê³„ë¶€</h1>
            <div class="flex items-center gap-2">
              <button onclick="state.showCompoundCalc=true;render()" class="bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-bold hover:bg-blue-50 transition shadow-md">ë³µë¦¬</button>
              <button onclick="state.showSettings=true;render()" class="bg-white text-blue-600 p-2 rounded-full hover:bg-blue-50 transition shadow-md">
                <i data-lucide="settings" class="w-4 h-4"></i>
              </button>
              <div class="${rankInfo.bgColor} px-3 py-1 rounded-full flex items-center gap-1 shadow-md">
                <span class="text-base">${rankInfo.icon}</span>
                <span class="text-sm font-bold ${rankInfo.color}">${rankInfo.rank}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderHomeScreen() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();

      const monthlyTx = state.transactions.filter(t => {
        const d = new Date(t.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });

      const totalIncome = monthlyTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const totalExpense = monthlyTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const necessaryExpense = monthlyTx.filter(t => t.type === 'expense' && t.isNecessary).reduce((s, t) => s + t.amount, 0);
      const unnecessaryExpense = monthlyTx.filter(t => t.type === 'expense' && !t.isNecessary).reduce((s, t) => s + t.amount, 0);

      const installmentTx = state.transactions.filter(t => t.installment > 0);
      const monthlyInstallment = installmentTx.reduce((sum, t) => {
        const tDate = new Date(t.date);
        const monthsSinceStart = (currentYear - tDate.getFullYear()) * 12 + (currentMonth - tDate.getMonth());
        if (monthsSinceStart >= 0 && monthsSinceStart < t.installment) {
          return sum + (t.amount / t.installment);
        }
        return sum;
      }, 0);

      const remainingInstallment = installmentTx.reduce((sum, t) => {
        const tDate = new Date(t.date);
        const monthsSinceStart = (currentYear - tDate.getFullYear()) * 12 + (currentMonth - tDate.getMonth());
        const remainingMonths = Math.max(0, t.installment - monthsSinceStart);
        return sum + (t.amount / t.installment * remainingMonths);
      }, 0);

      const totalBalance = totalIncome - totalExpense;
      const recentTx = [...state.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

      return `
        <div class="p-4 space-y-4">
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
            <div class="text-sm opacity-90 mb-1">ì´ ì”ì•¡</div>
            <div class="text-3xl font-bold mb-3">${formatNumber(totalBalance)}ì›</div>
            <div class="flex gap-2">
              ${state.undoStack.length > 0 ? `
                <button onclick="handleUndo()" class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-50 transition">
                  <i data-lucide="undo-2" class="w-4 h-4"></i> ì‹¤í–‰ ì·¨ì†Œ
                </button>
              ` : ''}
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm">
              <div class="text-xs text-green-600 mb-1">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>
              <div class="text-xl font-bold text-green-700">${formatNumber(totalIncome)}ì›</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg border border-red-200 shadow-sm">
              <div class="text-xs text-red-600 mb-1">ì´ë²ˆ ë‹¬ ì§€ì¶œ</div>
              <div class="text-xl font-bold text-red-700">${formatNumber(totalExpense)}ì›</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 shadow-sm">
              <div class="text-xs text-purple-600 mb-1">ì´ë²ˆ ë‹¬ í• ë¶€</div>
              <div class="text-lg font-bold text-purple-700">${formatNumber(Math.round(monthlyInstallment))}ì›</div>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200 shadow-sm">
              <div class="text-xs text-orange-600 mb-1">ë‚¨ì€ í• ë¶€</div>
              <div class="text-lg font-bold text-orange-700">${formatNumber(Math.round(remainingInstallment))}ì›</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">
              <div class="text-xs text-blue-600 mb-1">í•„ìš” ì§€ì¶œ</div>
              <div class="text-lg font-bold text-blue-700">${formatNumber(necessaryExpense)}ì›</div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
              <div class="text-xs text-gray-600 mb-1">ë¶ˆí•„ìš” ì§€ì¶œ</div>
              <div class="text-lg font-bold text-gray-700">${formatNumber(unnecessaryExpense)}ì›</div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-bold">ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>
              <div class="flex gap-2">
                <button onclick="exportToCSV()" class="text-blue-600 text-sm flex items-center gap-1">
                  <i data-lucide="download" class="w-3.5 h-3.5"></i> CSV
                </button>
                <button onclick="exportData()" class="text-blue-600 text-sm flex items-center gap-1">
                  <i data-lucide="share-2" class="w-3.5 h-3.5"></i> ë°±ì—…
                </button>
              </div>
            </div>
            <div class="space-y-2">
              ${recentTx.length === 0 ? '<div class="text-center text-gray-400 py-4">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' :
                recentTx.map(t => `
                  <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                    <div>
                      <div class="font-medium">${t.category}</div>
                      <div class="text-xs text-gray-500">${t.date}</div>
                    </div>
                    <div class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                      ${t.type === 'income' ? '+' : '-'}${formatNumber(t.amount)}ì›
                    </div>
                  </div>
                `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderHistoryScreen() {
      return `
        <div class="p-4" id="history-screen">
          <div class="mb-4 space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs text-gray-600 mb-1">ì‹œì‘ì¼</label>
                <input type="date" id="startDate" class="w-full p-2 border rounded text-sm">
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                <input type="date" id="endDate" class="w-full p-2 border rounded text-sm">
              </div>
            </div>
            <input type="text" id="searchKeyword" class="w-full p-2 border rounded" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰">
          </div>

          <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
            <button onclick="setHistoryPeriod('daily')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md" data-period="daily">ì¼ë³„</button>
            <button onclick="setHistoryPeriod('weekly')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="weekly">ì£¼ë³„</button>
            <button onclick="setHistoryPeriod('monthly')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="monthly">ì›”ë³„</button>
            <button onclick="setHistoryPeriod('yearly')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="yearly">ë…„ë„ë³„</button>
          </div>

          <div id="history-list" class="space-y-4"></div>
        </div>
      `;
    }

    let historyPeriod = 'daily';
    let editingTxId = null;

    function setHistoryPeriod(period) {
      historyPeriod = period;
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.className = btn.dataset.period === period 
          ? 'period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md'
          : 'period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200';
      });
      updateHistoryList();
    }

    function updateHistoryList() {
      const startDate = document.getElementById('startDate')?.value;
      const endDate = document.getElementById('endDate')?.value;
      const keyword = document.getElementById('searchKeyword')?.value || '';

      const filtered = state.transactions.filter(t => {
        const tDate = new Date(t.date);
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;
        const dateMatch = (!start || tDate >= start) && (!end || tDate <= end);
        const keywordMatch = !keyword || t.category.includes(keyword) || (t.memo && t.memo.includes(keyword));
        return dateMatch && keywordMatch;
      });

      const grouped = {};
      filtered.forEach(t => {
        const date = new Date(t.date);
        let key;
        if (historyPeriod === 'daily') key = t.date;
        else if (historyPeriod === 'weekly') {
          const weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0];
        } else if (historyPeriod === 'monthly') {
          key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        } else {
          key = String(date.getFullYear());
        }
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
      });

      const listEl = document.getElementById('history-list');
      if (!listEl) return;

      if (Object.keys(grouped).length === 0) {
        listEl.innerHTML = '<div class="text-center text-gray-400 py-8">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      listEl.innerHTML = Object.keys(grouped).sort().reverse().map(period => {
        const txs = grouped[period];
        const income = txs.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
        const expense = txs.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
        const balance = income - expense;

        return `
          <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="mb-3">
              <h3 class="font-bold text-lg mb-2">${period}</h3>
              <div class="grid grid-cols-3 gap-2 bg-gray-50 p-3 rounded-lg">
                <div><div class="text-xs text-green-600">ìˆ˜ì…</div><div class="text-sm font-bold text-green-700">${formatNumber(income)}ì›</div></div>
                <div><div class="text-xs text-red-600">ì§€ì¶œ</div><div class="text-sm font-bold text-red-700">${formatNumber(expense)}ì›</div></div>
                <div><div class="text-xs text-blue-600">ì”ê³ </div><div class="text-sm font-bold ${balance >= 0 ? 'text-blue-700' : 'text-red-700'}">${formatNumber(balance)}ì›</div></div>
              </div>
            </div>
            ${txs.map(t => `
              <div class="border-b py-2 last:border-b-0" id="tx-${t.id}">
                <div class="flex justify-between items-center">
                  <div class="flex-1">
                    <div class="font-medium">${t.category}</div>
                    <div class="text-xs text-gray-500">${t.date} ${t.memo ? `- ${t.memo}` : ''}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                      ${t.type === 'income' ? '+' : '-'}${formatNumber(t.amount)}ì›
                    </div>
                    <button onclick="editTransaction(${t.id})" class="text-blue-500 text-sm px-1">ìˆ˜ì •</button>
                    <button onclick="deleteTransaction(${t.id})" class="text-red-500 text-sm px-1">ì‚­ì œ</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('');
    }

    function deleteTransaction(id) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const tx = state.transactions.find(t => t.id === id);
        if (tx) addToUndoStack('deleteTransaction', tx);
        state.transactions = state.transactions.filter(t => t.id !== id);
        saveData();
        updateHistoryList();
        showToast('ê±°ë˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function editTransaction(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;
      
      const newAmount = prompt('ê¸ˆì•¡:', tx.amount);
      if (newAmount === null) return;
      
      const newCategory = prompt('ì¹´í…Œê³ ë¦¬:', tx.category);
      if (newCategory === null) return;
      
      const newMemo = prompt('ë©”ëª¨:', tx.memo || '');
      if (newMemo === null) return;
      
      tx.amount = Number(newAmount) || tx.amount;
      tx.category = newCategory || tx.category;
      tx.memo = newMemo;
      
      saveData();
      updateHistoryList();
      showToast('ê±°ë˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function renderStatsScreen() {
      return `
        <div class="p-4" id="stats-screen">
          <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
            <button onclick="setStatsPeriod('daily')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="daily">ì¼ë³„</button>
            <button onclick="setStatsPeriod('weekly')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="weekly">ì£¼ë³„</button>
            <button onclick="setStatsPeriod('monthly')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md" data-period="monthly">ì›”ë³„</button>
            <button onclick="setStatsPeriod('yearly')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="yearly">ë…„ë„ë³„</button>
          </div>
          <div id="stats-content"></div>
        </div>
      `;
    }

    let statsPeriod = 'monthly';

    function setStatsPeriod(period) {
      statsPeriod = period;
      document.querySelectorAll('.stats-btn').forEach(btn => {
        btn.className = btn.dataset.period === period 
          ? 'stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md'
          : 'stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200';
      });
      updateStatsContent();
    }

    function updateStatsContent() {
      const now = new Date();
      const filtered = state.transactions.filter(t => {
        const d = new Date(t.date);
        if (statsPeriod === 'daily') return d.toDateString() === now.toDateString();
        if (statsPeriod === 'weekly') return d >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        if (statsPeriod === 'monthly') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        return d.getFullYear() === now.getFullYear();
      });

      const categoryStats = {};
      filtered.forEach(t => {
        if (!categoryStats[t.category]) categoryStats[t.category] = { income: 0, expense: 0 };
        if (t.type === 'income') categoryStats[t.category].income += t.amount;
        else categoryStats[t.category].expense += t.amount;
      });

      const totalIncome = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const totalExpense = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const maxAmount = Math.max(totalIncome, totalExpense, 1);

      const contentEl = document.getElementById('stats-content');
      if (!contentEl) return;

      contentEl.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <h3 class="font-bold mb-4">ìˆ˜ì… / ì§€ì¶œ í•©ê³„</h3>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-green-600 font-medium">ìˆ˜ì…</span>
                <span class="text-green-600 font-bold">${formatNumber(totalIncome)}ì›</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6">
                <div class="bg-gradient-to-r from-green-400 to-green-500 h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ${(totalIncome / maxAmount) * 100}%">
                  <span class="text-xs text-white font-bold">${Math.round((totalIncome / maxAmount) * 100)}%</span>
                </div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-red-600 font-medium">ì§€ì¶œ</span>
                <span class="text-red-600 font-bold">${formatNumber(totalExpense)}ì›</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6">
                <div class="bg-gradient-to-r from-red-400 to-red-500 h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ${(totalExpense / maxAmount) * 100}%">
                  <span class="text-xs text-white font-bold">${Math.round((totalExpense / maxAmount) * 100)}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-4">
          <h3 class="font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ í†µê³„</h3>
          <div class="space-y-3">
            ${Object.keys(categoryStats).length === 0 ? '<div class="text-center text-gray-400 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>' :
              Object.entries(categoryStats).map(([cat, amounts]) => `
                <div class="border-b pb-3">
                  <div class="font-medium mb-2">${cat}</div>
                  ${amounts.income > 0 ? `
                    <div class="mb-1">
                      <div class="flex justify-between text-xs mb-1">
                        <span class="text-green-600">ìˆ˜ì…</span>
                        <span class="text-green-600 font-bold">${formatNumber(amounts.income)}ì›</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-green-400 h-4 rounded-full transition-all" style="width: ${(amounts.income / maxAmount) * 100}%"></div>
                      </div>
                    </div>
                  ` : ''}
                  ${amounts.expense > 0 ? `
                    <div>
                      <div class="flex justify-between text-xs mb-1">
                        <span class="text-red-600">ì§€ì¶œ</span>
                        <span class="text-red-600 font-bold">${formatNumber(amounts.expense)}ì›</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-red-400 h-4 rounded-full transition-all" style="width: ${(amounts.expense / maxAmount) * 100}%"></div>
                      </div>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
          </div>
        </div>
      `;
    }

    function renderGoalScreen() {
      const totalBank = state.bankBalances.reduce((s, b) => s + b.balance, 0);
      const calcAchievement = (goal) => {
        const g = Number(goal) || 0;
        return g === 0 ? 0 : Math.min((totalBank / g) * 100, 100);
      };

      const goalData = [
        { label: '7ë…„ ëª©í‘œ', key: 'year7', icon: 'ğŸ‘‘', color: 'purple' },
        { label: '5ë…„ ëª©í‘œ', key: 'year5', icon: 'ğŸ’', color: 'blue' },
        { label: '3ë…„ ëª©í‘œ', key: 'year3', icon: 'ğŸ†', color: 'green' },
        { label: 'ì˜¬í•´ ëª©í‘œ', key: 'thisYear', icon: 'â­', color: 'yellow' }
      ];

      return `
        <div class="p-4 space-y-6">
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ìˆ˜ì… ëª©í‘œ</h3>
            <div class="space-y-3">
              ${goalData.map(g => `
                <div>
                  <label class="block text-sm font-medium mb-1 text-${g.color}-700">${g.icon} ${g.label}</label>
                  <div class="relative">
                    <input type="number" id="goal-${g.key}" value="${state.goals[g.key]}" class="w-full p-2 pr-8 border-2 border-${g.color}-300 rounded-lg bg-${g.color}-50 focus:border-${g.color}-500 focus:outline-none" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    <span class="absolute right-3 top-2.5 text-gray-500 text-sm">ì›</span>
                  </div>
                </div>
              `).join('')}
              <button onclick="saveGoals()" class="w-full bg-blue-500 text-white py-2 rounded-lg font-medium hover:bg-blue-600 transition shadow-md">ëª©í‘œ ì €ì¥</button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ëª©í‘œ ë‹¬ì„± í˜„í™©</h3>
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg mb-4">
              <div class="text-sm text-blue-600">í˜„ì¬ í†µì¥ ì”ê³ </div>
              <div class="text-2xl font-bold text-blue-700">${formatNumber(totalBank)}ì›</div>
            </div>
            <div class="space-y-4">
              ${goalData.filter(g => Number(state.goals[g.key]) > 0).map(g => {
                const goalAmt = Number(state.goals[g.key]);
                const ach = calcAchievement(state.goals[g.key]);
                const remaining = Math.max(0, goalAmt - totalBank);
                const barColor = ach >= 100 ? 'from-green-400 to-green-500' : ach >= 75 ? 'from-blue-400 to-blue-500' : ach >= 50 ? 'from-yellow-400 to-yellow-500' : 'from-orange-400 to-orange-500';
                return `
                  <div class="border-b pb-4 last:border-b-0">
                    <div class="flex justify-between items-center mb-2">
                      <span class="font-medium text-gray-700">${g.label}</span>
                      <span class="text-sm text-gray-600">${formatNumber(totalBank)} / ${formatNumber(goalAmt)}ì›</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-8 mb-2 relative overflow-hidden">
                      <div class="h-8 rounded-full flex items-center justify-end pr-3 transition-all bg-gradient-to-r ${barColor}" style="width: ${ach}%">
                        <span class="text-white font-bold text-sm">${ach.toFixed(1)}%</span>
                      </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600">
                      <span>ë‹¬ì„±ë¥ : ${ach.toFixed(1)}%</span>
                      ${remaining > 0 ? `<span class="text-red-600">ëª©í‘œê¹Œì§€: ${formatNumber(remaining)}ì›</span>` : ''}
                      ${ach >= 100 ? '<span class="text-green-600 font-bold">âœ“ ëª©í‘œ ë‹¬ì„±!</span>' : ''}
                    </div>
                  </div>
                `;
              }).join('') || '<div class="text-center text-gray-400 py-4">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>'}
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ì€í–‰ë³„ í†µí•©ì”ê³ </h3>
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg mb-4">
              <div class="text-sm text-blue-600">ì´ ì”ê³ </div>
              <div class="text-2xl font-bold text-blue-700">${formatNumber(totalBank)}ì›</div>
            </div>
            <div class="space-y-2 mb-4" id="bank-list">
              ${state.bankBalances.map(b => `
                <div class="flex justify-between items-center p-3 border rounded-lg bg-gray-50">
                  <div><div class="font-medium">${b.name}</div><div class="text-sm text-gray-600">${formatNumber(b.balance)}ì›</div></div>
                  <button onclick="deleteBank(${b.id})" class="text-red-500 text-sm px-2 py-1 hover:bg-red-50 rounded">ì‚­ì œ</button>
                </div>
              `).join('')}
            </div>
            <div class="space-y-2">
              <input type="text" id="newBankName" class="w-full p-2 border rounded-lg" placeholder="ì€í–‰ëª…">
              <input type="number" id="newBankBalance" class="w-full p-2 border rounded-lg" placeholder="ì”ê³ ">
              <button onclick="addBank()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition shadow-md">ì€í–‰ ì¶”ê°€</button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ì¼ì¼ ë©”ëª¨ì¥</h3>
            <input type="date" id="searchMemoDate" class="w-full p-2 border rounded-lg mb-2" placeholder="ë‚ ì§œ ê²€ìƒ‰" onchange="filterMemos()">
            <div class="space-y-3 mb-4 max-h-64 overflow-y-auto" id="memo-list"></div>
            <div class="space-y-2">
              <input type="date" id="memoDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg">
              <textarea id="memoContent" class="w-full p-2 border rounded-lg" rows="4" placeholder="ì˜¤ëŠ˜ì˜ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”"></textarea>
              <button onclick="addMemo()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition shadow-md">ë©”ëª¨ ì¶”ê°€</button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ğŸ“… í–‰ì‚¬ì¼ì • ìº˜ë¦°ë”</h3>
            <div class="space-y-3 mb-4 max-h-64 overflow-y-auto" id="event-list"></div>
            <div class="space-y-2 border-t pt-4">
              <input type="text" id="eventTitle" class="w-full p-2 border rounded-lg" placeholder="í–‰ì‚¬ ì œëª©">
              <input type="date" id="eventDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg">
              <input type="text" id="eventDesc" class="w-full p-2 border rounded-lg" placeholder="í–‰ì‚¬ ì„¤ëª… (ì„ íƒì‚¬í•­)">
              <button onclick="addEvent()" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition shadow-md">í–‰ì‚¬ ì¶”ê°€</button>
            </div>
          </div>
        </div>
      `;
    }

    function saveGoals() {
      state.goals = {
        year7: document.getElementById('goal-year7')?.value || '',
        year5: document.getElementById('goal-year5')?.value || '',
        year3: document.getElementById('goal-year3')?.value || '',
        thisYear: document.getElementById('goal-thisYear')?.value || ''
      };
      saveData();
      showToast('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      render();
    }

    function addBank() {
      const name = document.getElementById('newBankName')?.value;
      const balance = Number(document.getElementById('newBankBalance')?.value);
      if (!name || isNaN(balance)) { alert('ì€í–‰ëª…ê³¼ ì”ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.bankBalances.push({ id: Date.now(), name, balance });
      saveData();
      render();
      showToast('ì€í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteBank(id) {
      if (confirm('ì€í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.bankBalances = state.bankBalances.filter(b => b.id !== id);
        saveData();
        render();
        showToast('ì€í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function addMemo() {
      const date = document.getElementById('memoDate')?.value;
      const content = document.getElementById('memoContent')?.value;
      if (!content) return;
      state.memos.push({ id: Date.now(), date, content });
      saveData();
      document.getElementById('memoContent').value = '';
      filterMemos();
      showToast('ë©”ëª¨ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteMemo(id) {
      if (confirm('ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const memo = state.memos.find(m => m.id === id);
        if (memo) addToUndoStack('deleteMemo', memo);
        state.memos = state.memos.filter(m => m.id !== id);
        saveData();
        filterMemos();
        showToast('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function filterMemos() {
      const searchDate = document.getElementById('searchMemoDate')?.value || '';
      const filtered = state.memos.filter(m => !searchDate || m.date.includes(searchDate));
      const listEl = document.getElementById('memo-list');
      if (!listEl) return;
      listEl.innerHTML = filtered.length === 0 ? '<div class="text-center text-gray-400 py-4">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</div>' :
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).map(m => `
          <div class="border rounded-lg p-3 bg-yellow-50">
            <div class="flex justify-between items-start mb-2">
              <div class="text-sm text-gray-600">${m.date}</div>
              <button onclick="deleteMemo(${m.id})" class="text-red-500 text-sm">ì‚­ì œ</button>
            </div>
            <div class="text-gray-800 whitespace-pre-wrap">${m.content}</div>
          </div>
        `).join('');
    }

    function addEvent() {
      const title = document.getElementById('eventTitle')?.value;
      const date = document.getElementById('eventDate')?.value;
      const description = document.getElementById('eventDesc')?.value || '';
      if (!title || !date) { alert('í–‰ì‚¬ ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.events.push({ id: Date.now(), title, date, description });
      saveData();
      document.getElementById('eventTitle').value = '';
      document.getElementById('eventDesc').value = '';
      updateEventList();
      showToast('í–‰ì‚¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteEvent(id) {
      if (confirm('ì´ í–‰ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.events = state.events.filter(e => e.id !== id);
        saveData();
        updateEventList();
        showToast('í–‰ì‚¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function updateEventList() {
      const listEl = document.getElementById('event-list');
      if (!listEl) return;
      const today = new Date(); today.setHours(0, 0, 0, 0);
      listEl.innerHTML = state.events.length === 0 ? '<div class="text-center text-gray-400 py-4">ë“±ë¡ëœ í–‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' :
        state.events.sort((a, b) => new Date(a.date) - new Date(b.date)).map(e => {
          const eventDate = new Date(e.date); eventDate.setHours(0, 0, 0, 0);
          const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
          const isPast = daysUntil < 0, isToday = daysUntil === 0, isUpcoming = daysUntil > 0 && daysUntil <= 7;
          const bgClass = isPast ? 'bg-gray-50 opacity-60' : isToday ? 'bg-red-50 border-red-300' : isUpcoming ? 'bg-yellow-50 border-yellow-300' : 'bg-white';
          return `
            <div class="border rounded-lg p-3 ${bgClass}">
              <div class="flex justify-between items-start mb-2">
                <div class="flex-1"><div class="font-bold text-gray-800">${e.title}</div><div class="text-sm text-gray-600 mt-1">${e.date}</div>${e.description ? `<div class="text-sm text-gray-500 mt-1">${e.description}</div>` : ''}</div>
                <button onclick="deleteEvent(${e.id})" class="text-red-500 text-sm ml-2">ì‚­ì œ</button>
              </div>
              <div class="flex items-center gap-2 text-xs">
                ${isPast ? '<span class="text-gray-500">ì¢…ë£Œë¨</span>' : isToday ? '<span class="text-red-600 font-bold">ğŸ”” ì˜¤ëŠ˜!</span>' : isUpcoming ? `<span class="text-orange-600 font-bold">âš ï¸ ${daysUntil}ì¼ ë‚¨ìŒ</span>` : `<span class="text-blue-600">ğŸ“ ${daysUntil}ì¼ ë‚¨ìŒ</span>`}
              </div>
            </div>
          `;
        }).join('');
    }

    function renderAddTransactionModal() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddTransaction=false;render();}">
          <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-4 border-b sticky top-0 bg-white rounded-t-xl">
              <h2 class="text-xl font-bold">ê±°ë˜ ì¶”ê°€</h2>
            </div>
            <div class="p-4 space-y-4">
              <div class="flex gap-2">
                <button id="btn-expense" onclick="setTxType('expense')" class="flex-1 py-2 rounded-lg transition bg-red-500 text-white shadow-md">ì§€ì¶œ</button>
                <button id="btn-income" onclick="setTxType('income')" class="flex-1 py-2 rounded-lg transition bg-gray-200">ìˆ˜ì…</button>
              </div>
              <input type="hidden" id="txType" value="expense">
              <div><label class="block text-sm font-medium mb-1">ë‚ ì§œ</label><input type="date" id="txDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg"></div>
              <div><label class="block text-sm font-medium mb-1">ê¸ˆì•¡</label><input type="number" id="txAmount" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥"></div>
              <div id="expense-options">
                <div><label class="block text-sm font-medium mb-1">ê²°ì œìˆ˜ë‹¨</label>
                  <select id="txPayment" onchange="toggleInstallment()" class="w-full p-2 border rounded-lg"><option value="card">ì¹´ë“œ</option><option value="cash">í˜„ê¸ˆ</option></select>
                </div>
                <div id="installment-div" class="mt-4"><label class="block text-sm font-medium mb-1">í• ë¶€</label>
                  <select id="txInstallment" class="w-full p-2 border rounded-lg"><option value="0">ì¼ì‹œë¶ˆ</option>${[2,3,4,5,6,7,8,9,10,11,12,15,18,20,24,30,36].map(m => `<option value="${m}">${m}ê°œì›”</option>`).join('')}</select>
                </div>
                <div class="mt-4"><label class="block text-sm font-medium mb-1">ì§€ì¶œ ìœ í˜•</label>
                  <div class="flex gap-2">
                    <button id="btn-necessary" onclick="setNecessary(true)" class="flex-1 py-2 rounded-lg transition bg-blue-500 text-white shadow-md">í•„ìš”ì§€ì¶œ</button>
                    <button id="btn-unnecessary" onclick="setNecessary(false)" class="flex-1 py-2 rounded-lg transition bg-gray-200">ë¶ˆí•„ìš”ì§€ì¶œ</button>
                  </div>
                  <input type="hidden" id="txNecessary" value="true">
                </div>
              </div>
              <div><label class="block text-sm font-medium mb-1">ì¹´í…Œê³ ë¦¬</label>
                <select id="txCategory" class="w-full p-2 border rounded-lg"><option value="">ì„ íƒí•˜ì„¸ìš”</option>${state.categories.expense.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
              </div>
              <div><label class="block text-sm font-medium mb-1">ë©”ëª¨</label><textarea id="txMemo" class="w-full p-2 border rounded-lg" rows="3" placeholder="ë©”ëª¨ ì…ë ¥"></textarea></div>
              <div class="flex gap-2 pt-4">
                <button onclick="submitTransaction()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium shadow-md hover:bg-blue-600 transition">ì €ì¥</button>
                <button onclick="state.showAddTransaction=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium hover:bg-gray-400 transition">ì·¨ì†Œ</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    let currentTxType = 'expense';
    let isNecessary = true;

    function setTxType(type) {
      currentTxType = type;
      document.getElementById('txType').value = type;
      document.getElementById('btn-expense').className = type === 'expense' ? 'flex-1 py-2 rounded-lg transition bg-red-500 text-white shadow-md' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      document.getElementById('btn-income').className = type === 'income' ? 'flex-1 py-2 rounded-lg transition bg-green-500 text-white shadow-md' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      document.getElementById('expense-options').style.display = type === 'expense' ? 'block' : 'none';
      
      const catSelect = document.getElementById('txCategory');
      catSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + state.categories[type].map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function setNecessary(val) {
      isNecessary = val;
      document.getElementById('txNecessary').value = val;
      document.getElementById('btn-necessary').className = val ? 'flex-1 py-2 rounded-lg transition bg-blue-500 text-white shadow-md' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      document.getElementById('btn-unnecessary').className = !val ? 'flex-1 py-2 rounded-lg transition bg-gray-500 text-white shadow-md' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
    }

    function toggleInstallment() {
      const payment = document.getElementById('txPayment').value;
      document.getElementById('installment-div').style.display = payment === 'card' ? 'block' : 'none';
    }

    function submitTransaction() {
      const type = document.getElementById('txType').value;
      const date = document.getElementById('txDate').value;
      const amount = Number(document.getElementById('txAmount').value);
      const category = document.getElementById('txCategory').value;
      const memo = document.getElementById('txMemo').value;
      
      if (!category) { alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
      if (!amount || amount <= 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (amount > 1000000000) { alert('ê¸ˆì•¡ì´ ë„ˆë¬´ í½ë‹ˆë‹¤'); return; }

      const tx = {
        id: Date.now(),
        type,
        date,
        amount,
        category,
        memo,
        paymentMethod: type === 'expense' ? document.getElementById('txPayment').value : 'cash',
        installment: type === 'expense' && document.getElementById('txPayment').value === 'card' ? Number(document.getElementById('txInstallment').value) : 0,
        isNecessary: type === 'expense' ? document.getElementById('txNecessary').value === 'true' : true
      };

      state.transactions.push(tx);
      state.showAddTransaction = false;
      saveData();
      render();
      showToast('ê±°ë˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function renderCompoundCalc() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showCompoundCalc=false;render();}">
          <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-4 border-b sticky top-0 bg-white rounded-t-xl z-10">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">ğŸ’° ì ë¦½ì‹ ë³µë¦¬ê³„ì‚°ê¸°</h2>
                <button onclick="state.showCompoundCalc=false;render()" class="text-gray-500 hover:text-gray-700 text-2xl w-8 h-8 flex items-center justify-center">âœ•</button>
              </div>
            </div>
            <div class="p-4 space-y-4">
              <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl space-y-3">
                <div><label class="block text-sm font-medium mb-1">ì´ˆê¸° íˆ¬ìê¸ˆ</label><div class="relative"><input type="number" id="calcInitial" class="w-full p-3 pr-10 border rounded-lg" placeholder="0"><span class="absolute right-3 top-3.5 text-gray-500 text-sm">ì›</span></div></div>
                <div><label class="block text-sm font-medium mb-1">ì›” ì ë¦½ê¸ˆ</label><div class="relative"><input type="number" id="calcMonthly" class="w-full p-3 pr-10 border rounded-lg" placeholder="0"><span class="absolute right-3 top-3.5 text-gray-500 text-sm">ì›</span></div></div>
                <div><label class="block text-sm font-medium mb-1">íˆ¬ì ê¸°ê°„</label><div class="relative"><input type="number" id="calcYears" class="w-full p-3 pr-10 border rounded-lg" placeholder="0"><span class="absolute right-3 top-3.5 text-gray-500 text-sm">ë…„</span></div></div>
                <div><label class="block text-sm font-medium mb-1">ì—° ìˆ˜ìµë¥ </label><div class="relative"><input type="number" step="0.1" id="calcRate" class="w-full p-3 pr-10 border rounded-lg" placeholder="0"><span class="absolute right-3 top-3.5 text-gray-500 text-sm">%</span></div></div>
                <button onclick="calculateCompound()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-bold hover:from-blue-700 hover:to-purple-700 transition shadow-lg">ê³„ì‚°í•˜ê¸°</button>
              </div>
              <div id="calc-result"></div>
            </div>
          </div>
        </div>
      `;
    }

    function calculateCompound() {
      const initial = Number(document.getElementById('calcInitial').value) || 0;
      const monthly = Number(document.getElementById('calcMonthly').value) || 0;
      const years = Number(document.getElementById('calcYears').value) || 0;
      const rate = Number(document.getElementById('calcRate').value) / 100 || 0;

      if (years === 0) { alert('ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      const yearlyData = [];
      let currentAmount = initial;

      for (let year = 1; year <= years; year++) {
        for (let month = 1; month <= 12; month++) {
          currentAmount += monthly;
          currentAmount = currentAmount * (1 + rate / 12);
        }
        const totalDeposit = initial + (monthly * 12 * year);
        yearlyData.push({ year, amount: Math.round(currentAmount), deposit: totalDeposit, interest: Math.round(currentAmount - totalDeposit) });
      }

      const finalAmount = Math.round(currentAmount);
      const totalDeposit = initial + (monthly * 12 * years);
      const totalInterest = finalAmount - totalDeposit;
      const maxAmount = Math.max(...yearlyData.map(d => d.amount));

      document.getElementById('calc-result').innerHTML = `
        <div class="bg-gradient-to-r from-purple-100 to-blue-100 p-5 rounded-xl shadow-lg">
          <h3 class="font-bold text-lg mb-4 text-center text-purple-700">ìµœì¢… ê²°ê³¼</h3>
          <div class="grid grid-cols-3 gap-3">
            <div class="bg-white p-4 rounded-lg text-center shadow"><div class="text-xs text-gray-600 mb-1">ìµœì¢… ê¸ˆì•¡</div><div class="text-lg font-bold text-purple-600">${formatNumber(finalAmount)}ì›</div></div>
            <div class="bg-white p-4 rounded-lg text-center shadow"><div class="text-xs text-gray-600 mb-1">ì´ ë‚©ì…ê¸ˆ</div><div class="text-lg font-bold text-blue-600">${formatNumber(totalDeposit)}ì›</div></div>
            <div class="bg-white p-4 rounded-lg text-center shadow"><div class="text-xs text-gray-600 mb-1">ì´ ì´ì</div><div class="text-lg font-bold text-green-600">${formatNumber(totalInterest)}ì›</div></div>
          </div>
        </div>
        <div class="bg-white rounded-xl border shadow-lg p-4 mt-4">
          <h3 class="font-bold mb-4">ğŸ“ˆ ë…„ë„ë³„ ê·¸ë˜í”„</h3>
          <div class="space-y-3">
            ${yearlyData.map(d => `
              <div class="space-y-1">
                <div class="flex justify-between text-sm"><span class="font-medium">${d.year}ë…„ì°¨</span><span class="font-bold text-purple-600">${formatNumber(d.amount)}ì›</span></div>
                <div class="relative w-full bg-gray-200 rounded-full h-7 overflow-hidden">
                  <div class="absolute left-0 top-0 h-7 bg-gradient-to-r from-blue-400 via-purple-500 to-purple-600 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ${(d.amount / maxAmount) * 100}%">
                    <span class="text-xs text-white font-bold drop-shadow">${Math.round((d.amount / maxAmount) * 100)}%</span>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderSettings() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showSettings=false;render();}">
          <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-4 border-b sticky top-0 bg-white rounded-t-xl z-10">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">âš™ï¸ ì„¤ì •</h2>
                <button onclick="state.showSettings=false;render()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
              </div>
            </div>
            <div class="p-4 space-y-6">
              <div class="bg-white rounded-xl border shadow-sm p-4">
                <h3 class="font-bold mb-4">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3>
                <div class="flex gap-2 mb-4">
                  <button id="cat-expense-btn" onclick="setCatType('expense')" class="flex-1 py-2 rounded-lg transition bg-red-500 text-white">ì§€ì¶œ</button>
                  <button id="cat-income-btn" onclick="setCatType('income')" class="flex-1 py-2 rounded-lg transition bg-gray-200">ìˆ˜ì…</button>
                </div>
                <div class="space-y-2 mb-4 max-h-48 overflow-y-auto" id="category-list"></div>
                <div class="flex gap-2">
                  <input type="text" id="newCatName" class="flex-1 p-2 border rounded-lg" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„">
                  <button onclick="addCategory()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">ì¶”ê°€</button>
                </div>
              </div>
              <div class="bg-white rounded-xl border shadow-sm p-4">
                <h3 class="font-bold mb-4">ë°ì´í„° ê´€ë¦¬</h3>
                <div class="space-y-3">
                  <button onclick="exportData()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition flex items-center justify-center gap-2"><i data-lucide="download" class="w-5 h-5"></i>ë°ì´í„° ë°±ì—… (JSON)</button>
                  <button onclick="exportToCSV()" class="w-full bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600 transition flex items-center justify-center gap-2"><i data-lucide="download" class="w-5 h-5"></i>ê±°ë˜ë‚´ì—­ ë‚´ë³´ë‚´ê¸° (CSV)</button>
                  <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden">
                  <button onclick="document.getElementById('importFile').click()" class="w-full bg-purple-500 text-white py-3 rounded-lg font-medium hover:bg-purple-600 transition flex items-center justify-center gap-2"><i data-lucide="upload" class="w-5 h-5"></i>ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSON)</button>
                  <button onclick="resetAllData()" class="w-full bg-red-500 text-white py-3 rounded-lg font-medium hover:bg-red-600 transition">ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
                </div>
              </div>
              <div class="bg-white rounded-xl border shadow-sm p-4">
                <h3 class="font-bold mb-2">ì•± ì •ë³´</h3>
                <div class="text-sm text-gray-600 space-y-1">
                  <p>ë²„ì „: 2.0</p>
                  <p>ì´ ê±°ë˜: ${state.transactions.length}ê±´</p>
                  <p>ì´ ë©”ëª¨: ${state.memos.length}ê°œ</p>
                  <p>ì´ í–‰ì‚¬: ${state.events.length}ê°œ</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    let currentCatType = 'expense';

    function setCatType(type) {
      currentCatType = type;
      document.getElementById('cat-expense-btn').className = type === 'expense' ? 'flex-1 py-2 rounded-lg transition bg-red-500 text-white' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      document.getElementById('cat-income-btn').className = type === 'income' ? 'flex-1 py-2 rounded-lg transition bg-green-500 text-white' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      updateCategoryList();
    }

    function updateCategoryList() {
      const listEl = document.getElementById('category-list');
      if (!listEl) return;
      listEl.innerHTML = state.categories[currentCatType].map((c, i) => `
        <div class="flex justify-between items-center p-2 border rounded bg-gray-50">
          <span>${c}</span>
          <button onclick="deleteCategory('${currentCatType}', ${i})" class="text-red-500 text-sm px-2">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    function addCategory() {
      const name = document.getElementById('newCatName')?.value?.trim();
      if (!name) { alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.categories[currentCatType].push(name);
      saveData();
      document.getElementById('newCatName').value = '';
      updateCategoryList();
      showToast('ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteCategory(type, index) {
      if (confirm(`'${state.categories[type][index]}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        state.categories[type].splice(index, 1);
        saveData();
        updateCategoryList();
        showToast('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function resetAllData() {
      if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?') && confirm('ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•©ë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
        state.transactions = [];
        state.memos = [];
        state.events = [];
        state.bankBalances = [];
        state.goals = { year7: '', year5: '', year3: '', thisYear: '' };
        state.undoStack = [];
        saveData();
        state.showSettings = false;
        render();
        showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function renderNavbar() {
      const tabs = [
        { id: 'home', icon: 'home', label: 'í™ˆ' },
        { id: 'history', icon: 'file-text', label: 'ë‚´ì—­' },
        { id: 'add', icon: 'plus', label: '' },
        { id: 'stats', icon: 'bar-chart-3', label: 'í†µê³„' },
        { id: 'goal', icon: 'target', label: 'ëª©í‘œ' }
      ];

      return `
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl max-w-md mx-auto">
          <div class="flex justify-around items-center p-2">
            ${tabs.map(t => t.id === 'add' ? `
              <button onclick="state.showAddTransaction=true;render()" class="flex flex-col items-center p-2 -mt-8">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full p-4 shadow-2xl hover:scale-110 transition transform">
                  <i data-lucide="plus" class="w-7 h-7" style="stroke-width: 3"></i>
                </div>
              </button>
            ` : `
              <button onclick="setActiveTab('${t.id}')" class="flex flex-col items-center p-2 rounded-lg transition ${state.activeTab === t.id ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}">
                <i data-lucide="${t.icon}" class="w-6 h-6"></i>
                <span class="text-xs mt-1 font-medium">${t.label}</span>
              </button>
            `).join('')}
          </div>
        </div>
      `;
    }

    function setActiveTab(tab) {
      state.activeTab = tab;
      render();
    }

    function render() {
      const app = document.getElementById('app');
      
      if (state.isLoading) {
        app.innerHTML = `
          <div class="max-w-md mx-auto bg-gray-50 min-h-screen flex items-center justify-center">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <div class="text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
          </div>
        `;
        return;
      }

      let content = '';
      if (state.activeTab === 'home') content = renderHomeScreen();
      else if (state.activeTab === 'history') content = renderHistoryScreen();
      else if (state.activeTab === 'stats') content = renderStatsScreen();
      else if (state.activeTab === 'goal') content = renderGoalScreen();

      app.innerHTML = `
        ${renderHeader()}
        <div class="pb-4">${content}</div>
        ${renderNavbar()}
        ${state.showAddTransaction ? renderAddTransactionModal() : ''}
        ${state.showCompoundCalc ? renderCompoundCalc() : ''}
        ${state.showSettings ? renderSettings() : ''}
      `;

      lucide.createIcons();

      // Post-render updates
      setTimeout(() => {
        if (state.activeTab === 'history') {
          updateHistoryList();
          document.getElementById('startDate')?.addEventListener('change', updateHistoryList);
          document.getElementById('endDate')?.addEventListener('change', updateHistoryList);
          document.getElementById('searchKeyword')?.addEventListener('input', updateHistoryList);
        }
        if (state.activeTab === 'stats') updateStatsContent();
        if (state.activeTab === 'goal') {
          filterMemos();
          updateEventList();
        }
        if (state.showSettings) updateCategoryList();
      }, 0);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
</body>
</html>
