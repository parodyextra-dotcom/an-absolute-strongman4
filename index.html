<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì ˆëŒ€ê°•ì ê°€ê³„ë¶€</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="max-w-md mx-auto bg-gray-50 min-h-screen pb-20"></div>

  <script>
    // State Management
    const state = {
      activeTab: 'home',
      transactions: [],
      memos: [],
      events: [],
      goals: { year7: '', year5: '', year3: '', thisYear: '' },
      bankBalances: [],
      investments: [],
      dividends: [],
      // Exchange (í™˜ì „) state
      exchangeTab: 'USD',
      usdPhases: [],
      jpyPhases: [],
      usdRate: 1380,
      jpyRate: 920,
      usdNextId: 1,
      jpyNextId: 1,

      expandedPhase: null,
      showExchangeStats: false,
      exchangeStatsPeriod: 'yearly',
      exchangeStatsStartDate: '',
      exchangeStatsEndDate: '',
      soldItemsVisible: 10,
      categories: {
        expense: ['ì‹ë¹„', 'êµí†µë¹„', 'í†µì‹ ë¹„', 'ìƒí™œìš©í’ˆ', 'ì˜ë£Œë¹„', 'êµìœ¡ë¹„', 'ë¬¸í™”ìƒí™œ', 'ì•„ë²„ì§€', 'ì§€í™˜', 'ë‹¤í˜œ', 'ë‹¤ì—°', 'ë³´í—˜ë£Œ', 'ì™¸ì‹ë¹„', 'ì„¸ê¸ˆê³µê³¼ê¸ˆ', 'ì£¼ìœ ë¹„', 'ê¸°íƒ€ë¹„'],
        income: ['ê¸‰ì—¬', 'ì´ì', 'ëŒ€ë¦¬ì—…ë¬´', 'ë°°ë‹¹ê¸ˆ', 'ê¸°íƒ€ìˆ˜ì…']
      },
      undoStack: [],
      showAddTransaction: false,
      showCompoundCalc: false,
      showSettings: false,
      showAddInvestment: false,
      isLoading: true
    };

    // Storage helpers
    const storage = {
      get: (key) => {
        try {
          const value = localStorage.getItem(key);
          return value ? JSON.parse(value) : null;
        } catch { return null; }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) { console.error('Storage error:', e); }
      }
    };

    // Load data
    function loadData() {
      state.transactions = storage.get('transactions') || [];
      state.memos = storage.get('memos') || [];
      state.events = storage.get('events') || [];
      state.goals = storage.get('goals') || { year7: '', year5: '', year3: '', thisYear: '' };
      state.bankBalances = storage.get('bankBalances') || [];
      state.investments = storage.get('investments') || [];
      state.dividends = storage.get('dividends') || [];
      state.categories = storage.get('categories') || state.categories;
      // Load exchange data
      const exchangeData = storage.get('exchangeData');
      if (exchangeData) {
        state.usdPhases = exchangeData.usdPhases || [];
        state.jpyPhases = exchangeData.jpyPhases || [];
        state.usdRate = exchangeData.usdRate || 1380;
        state.jpyRate = exchangeData.jpyRate || 920;
        state.usdNextId = exchangeData.usdNextId || 1;
        state.jpyNextId = exchangeData.jpyNextId || 1;
      }
      state.isLoading = false;
      render();
    }

    // Save data
    function saveData() {
      storage.set('transactions', state.transactions);
      storage.set('memos', state.memos);
      storage.set('events', state.events);
      storage.set('goals', state.goals);
      storage.set('bankBalances', state.bankBalances);
      storage.set('investments', state.investments);
      storage.set('dividends', state.dividends);
      storage.set('categories', state.categories);
      // Save exchange data
      storage.set('exchangeData', {
        usdPhases: state.usdPhases,
        jpyPhases: state.jpyPhases,
        usdRate: state.usdRate,
        jpyRate: state.jpyRate,
        usdNextId: state.usdNextId,
        jpyNextId: state.jpyNextId
      });
    }

    // Toast notification
    let toastTimeout;
    function showToast(message, type = 'success') {
      const existing = document.getElementById('toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.id = 'toast';
      toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-500' : 'bg-green-500'
      } text-white font-medium animate-fade-in`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toast.remove(), 3000);
    }

    // Utility functions
    function formatNumber(num) {
      return num.toLocaleString();
    }

    function getRankInfo(balance) {
      if (balance >= 500000000) return { rank: 'ì ˆëŒ€ê°•ì', color: 'text-purple-600', bgColor: 'bg-purple-100', icon: 'ğŸ‘‘' };
      if (balance >= 200000000) return { rank: 'ì†Œë¶€ì', color: 'text-blue-600', bgColor: 'bg-blue-100', icon: 'ğŸ’' };
      if (balance >= 100000000) return { rank: 'ì¤‘ì‚°ì¸µ', color: 'text-green-600', bgColor: 'bg-green-100', icon: 'ğŸ†' };
      if (balance >= 50000000) return { rank: 'ì„œë¯¼', color: 'text-yellow-600', bgColor: 'bg-yellow-100', icon: 'â­' };
      if (balance >= 10000000) return { rank: 'ì°¨ìƒìœ„ì', color: 'text-orange-600', bgColor: 'bg-orange-100', icon: 'ğŸ”¶' };
      return { rank: 'ê¸°ì´ˆìˆ˜ê¸‰ì', color: 'text-gray-600', bgColor: 'bg-gray-100', icon: 'ğŸŒ±' };
    }

    function addToUndoStack(action, data) {
      state.undoStack.push({ action, data, timestamp: Date.now() });
      if (state.undoStack.length > 10) state.undoStack.shift();
    }

    function handleUndo() {
      if (state.undoStack.length === 0) return;
      const lastAction = state.undoStack.pop();
      
      if (lastAction.action === 'deleteTransaction') {
        state.transactions.push(lastAction.data);
        showToast('ê±°ë˜ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
      } else if (lastAction.action === 'deleteMemo') {
        state.memos.push(lastAction.data);
        showToast('ë©”ëª¨ ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤');
      }
      saveData();
      render();
    }

    // Export functions
    function exportData() {
      const data = {
        transactions: state.transactions,
        memos: state.memos,
        goals: state.goals,
        bankBalances: state.bankBalances,
        investments: state.investments,
        dividends: state.dividends,
        events: state.events,
        categories: state.categories,
        exchangeData: {
          usdPhases: state.usdPhases,
          jpyPhases: state.jpyPhases,
          usdRate: state.usdRate,
          jpyRate: state.jpyRate,
          usdNextId: state.usdNextId,
          jpyNextId: state.jpyNextId
        },
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `budget_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      showToast('ë°ì´í„°ê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function exportToCSV() {
      const headers = ['ë‚ ì§œ', 'ìœ í˜•', 'ì¹´í…Œê³ ë¦¬', 'ê¸ˆì•¡', 'ê²°ì œìˆ˜ë‹¨', 'í• ë¶€', 'í•„ìš”ì§€ì¶œ', 'ë©”ëª¨'];
      const rows = state.transactions.map(t => [
        t.date,
        t.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ',
        t.category,
        t.amount,
        t.paymentMethod === 'card' ? 'ì¹´ë“œ' : 'í˜„ê¸ˆ',
        t.installment || 'ì¼ì‹œë¶ˆ',
        t.isNecessary ? 'í•„ìš”' : 'ë¶ˆí•„ìš”',
        t.memo || ''
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');

      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `ê±°ë˜ë‚´ì—­_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
      showToast('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.transactions || !Array.isArray(data.transactions)) {
            throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹');
          }

          if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ê³  ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            state.transactions = data.transactions || [];
            state.memos = data.memos || [];
            state.goals = data.goals || { year7: '', year5: '', year3: '', thisYear: '' };
            state.bankBalances = data.bankBalances || [];
            state.investments = data.investments || [];
            state.dividends = data.dividends || [];
            state.events = data.events || [];
            if (data.categories) state.categories = data.categories;
            if (data.exchangeData) {
              state.usdPhases = data.exchangeData.usdPhases || [];
              state.jpyPhases = data.exchangeData.jpyPhases || [];
              state.usdRate = data.exchangeData.usdRate || 1380;
              state.jpyRate = data.exchangeData.jpyRate || 920;
              state.usdNextId = data.exchangeData.usdNextId || 1;
              state.jpyNextId = data.exchangeData.jpyNextId || 1;
            }
            saveData();
            render();
            showToast('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤');
          }
        } catch (error) {
          showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Render functions
    function renderHeader() {
      const totalBankBalance = state.bankBalances.reduce((sum, b) => sum + b.balance, 0);
      const rankInfo = getRankInfo(totalBankBalance);
      
      return `
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 sticky top-0 z-10 shadow-lg">
          <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold">ì ˆëŒ€ê°•ì ê°€ê³„ë¶€</h1>
            <div class="flex items-center gap-2">
              <button onclick="state.showCompoundCalc=true;render()" class="bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-bold hover:bg-blue-50 transition shadow-md">ë³µë¦¬</button>
              <button onclick="state.showSettings=true;render()" class="bg-white text-blue-600 p-2 rounded-full hover:bg-blue-50 transition shadow-md">
                <i data-lucide="settings" class="w-4 h-4"></i>
              </button>
              <div class="${rankInfo.bgColor} px-3 py-1 rounded-full flex items-center gap-1 shadow-md">
                <span class="text-base">${rankInfo.icon}</span>
                <span class="text-sm font-bold ${rankInfo.color}">${rankInfo.rank}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderHomeScreen() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();

      const monthlyTx = state.transactions.filter(t => {
        const d = new Date(t.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
      });

      const totalIncome = monthlyTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const totalExpense = monthlyTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const necessaryExpense = monthlyTx.filter(t => t.type === 'expense' && t.isNecessary).reduce((s, t) => s + t.amount, 0);
      const unnecessaryExpense = monthlyTx.filter(t => t.type === 'expense' && !t.isNecessary).reduce((s, t) => s + t.amount, 0);

      const installmentTx = state.transactions.filter(t => t.installment > 0);
      const monthlyInstallment = installmentTx.reduce((sum, t) => {
        const tDate = new Date(t.date);
        const monthsSinceStart = (currentYear - tDate.getFullYear()) * 12 + (currentMonth - tDate.getMonth());
        if (monthsSinceStart >= 0 && monthsSinceStart < t.installment) {
          return sum + (t.amount / t.installment);
        }
        return sum;
      }, 0);

      const remainingInstallment = installmentTx.reduce((sum, t) => {
        const tDate = new Date(t.date);
        const monthsSinceStart = (currentYear - tDate.getFullYear()) * 12 + (currentMonth - tDate.getMonth());
        const remainingMonths = Math.max(0, t.installment - monthsSinceStart);
        return sum + (t.amount / t.installment * remainingMonths);
      }, 0);

      const totalBalance = totalIncome - totalExpense;
      const recentTx = [...state.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

      return `
        <div class="p-4 space-y-4">
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
            <div class="text-sm opacity-90 mb-1">ì´ ì”ì•¡</div>
            <div class="text-3xl font-bold mb-3">${formatNumber(totalBalance)}ì›</div>
            <div class="flex gap-2">
              ${state.undoStack.length > 0 ? `
                <button onclick="handleUndo()" class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-50 transition">
                  <i data-lucide="undo-2" class="w-4 h-4"></i> ì‹¤í–‰ ì·¨ì†Œ
                </button>
              ` : ''}
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm">
              <div class="text-xs text-green-600 mb-1">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>
              <div class="text-xl font-bold text-green-700">${formatNumber(totalIncome)}ì›</div>
            </div>
            <div class="bg-red-50 p-4 rounded-lg border border-red-200 shadow-sm">
              <div class="text-xs text-red-600 mb-1">ì´ë²ˆ ë‹¬ ì§€ì¶œ</div>
              <div class="text-xl font-bold text-red-700">${formatNumber(totalExpense)}ì›</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 shadow-sm">
              <div class="text-xs text-purple-600 mb-1">ì´ë²ˆ ë‹¬ í• ë¶€</div>
              <div class="text-lg font-bold text-purple-700">${formatNumber(Math.round(monthlyInstallment))}ì›</div>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200 shadow-sm">
              <div class="text-xs text-orange-600 mb-1">ë‚¨ì€ í• ë¶€</div>
              <div class="text-lg font-bold text-orange-700">${formatNumber(Math.round(remainingInstallment))}ì›</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">
              <div class="text-xs text-blue-600 mb-1">í•„ìš” ì§€ì¶œ</div>
              <div class="text-lg font-bold text-blue-700">${formatNumber(necessaryExpense)}ì›</div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
              <div class="text-xs text-gray-600 mb-1">ë¶ˆí•„ìš” ì§€ì¶œ</div>
              <div class="text-lg font-bold text-gray-700">${formatNumber(unnecessaryExpense)}ì›</div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-bold">ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>
              <div class="flex gap-2">
                <button onclick="exportToCSV()" class="text-blue-600 text-sm flex items-center gap-1">
                  <i data-lucide="download" class="w-3.5 h-3.5"></i> CSV
                </button>
                <button onclick="exportData()" class="text-blue-600 text-sm flex items-center gap-1">
                  <i data-lucide="share-2" class="w-3.5 h-3.5"></i> ë°±ì—…
                </button>
              </div>
            </div>
            <div class="space-y-2">
              ${recentTx.length === 0 ? '<div class="text-center text-gray-400 py-4">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' :
                recentTx.map(t => `
                  <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                    <div>
                      <div class="font-medium">${t.category}</div>
                      <div class="text-xs text-gray-500">${t.date}</div>
                    </div>
                    <div class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                      ${t.type === 'income' ? '+' : '-'}${formatNumber(t.amount)}ì›
                    </div>
                  </div>
                `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderHistoryScreen() {
      return `
        <div class="p-4" id="history-screen">
          <div class="mb-4 space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs text-gray-600 mb-1">ì‹œì‘ì¼</label>
                <input type="date" id="startDate" class="w-full p-2 border rounded text-sm">
              </div>
              <div>
                <label class="block text-xs text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                <input type="date" id="endDate" class="w-full p-2 border rounded text-sm">
              </div>
            </div>
            <input type="text" id="searchKeyword" class="w-full p-2 border rounded" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰">
          </div>

          <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
            <button onclick="setHistoryPeriod('daily')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md" data-period="daily">ì¼ë³„</button>
            <button onclick="setHistoryPeriod('weekly')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="weekly">ì£¼ë³„</button>
            <button onclick="setHistoryPeriod('monthly')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="monthly">ì›”ë³„</button>
            <button onclick="setHistoryPeriod('yearly')" class="period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="yearly">ë…„ë„ë³„</button>
          </div>

          <div id="history-list" class="space-y-4"></div>
        </div>
      `;
    }

    let historyPeriod = 'daily';
    let editingTxId = null;

    function setHistoryPeriod(period) {
      historyPeriod = period;
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.className = btn.dataset.period === period 
          ? 'period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md'
          : 'period-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200';
      });
      updateHistoryList();
    }

    function updateHistoryList() {
      const startDate = document.getElementById('startDate')?.value;
      const endDate = document.getElementById('endDate')?.value;
      const keyword = document.getElementById('searchKeyword')?.value || '';

      const filtered = state.transactions.filter(t => {
        const tDate = new Date(t.date);
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;
        const dateMatch = (!start || tDate >= start) && (!end || tDate <= end);
        const keywordMatch = !keyword || t.category.includes(keyword) || (t.memo && t.memo.includes(keyword));
        return dateMatch && keywordMatch;
      });

      const grouped = {};
      filtered.forEach(t => {
        const date = new Date(t.date);
        let key;
        if (historyPeriod === 'daily') key = t.date;
        else if (historyPeriod === 'weekly') {
          const weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0];
        } else if (historyPeriod === 'monthly') {
          key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        } else {
          key = String(date.getFullYear());
        }
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
      });

      const listEl = document.getElementById('history-list');
      if (!listEl) return;

      if (Object.keys(grouped).length === 0) {
        listEl.innerHTML = '<div class="text-center text-gray-400 py-8">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      listEl.innerHTML = Object.keys(grouped).sort().reverse().map(period => {
        const txs = grouped[period];
        const income = txs.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
        const expense = txs.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
        const balance = income - expense;

        return `
          <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="mb-3">
              <h3 class="font-bold text-lg mb-2">${period}</h3>
              <div class="grid grid-cols-3 gap-2 bg-gray-50 p-3 rounded-lg">
                <div><div class="text-xs text-green-600">ìˆ˜ì…</div><div class="text-sm font-bold text-green-700">${formatNumber(income)}ì›</div></div>
                <div><div class="text-xs text-red-600">ì§€ì¶œ</div><div class="text-sm font-bold text-red-700">${formatNumber(expense)}ì›</div></div>
                <div><div class="text-xs text-blue-600">ì”ê³ </div><div class="text-sm font-bold ${balance >= 0 ? 'text-blue-700' : 'text-red-700'}">${formatNumber(balance)}ì›</div></div>
              </div>
            </div>
            ${txs.map(t => `
              <div class="border-b py-2 last:border-b-0" id="tx-${t.id}">
                <div class="flex justify-between items-center">
                  <div class="flex-1">
                    <div class="font-medium">${t.category}</div>
                    <div class="text-xs text-gray-500">${t.date} ${t.memo ? `- ${t.memo}` : ''}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                      ${t.type === 'income' ? '+' : '-'}${formatNumber(t.amount)}ì›
                    </div>
                    <button onclick="editTransaction(${t.id})" class="text-blue-500 text-sm px-1">ìˆ˜ì •</button>
                    <button onclick="deleteTransaction(${t.id})" class="text-red-500 text-sm px-1">ì‚­ì œ</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('');
    }

    function deleteTransaction(id) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const tx = state.transactions.find(t => t.id === id);
        if (tx) addToUndoStack('deleteTransaction', tx);
        state.transactions = state.transactions.filter(t => t.id !== id);
        saveData();
        updateHistoryList();
        showToast('ê±°ë˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function editTransaction(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;
      
      const newAmount = prompt('ê¸ˆì•¡:', tx.amount);
      if (newAmount === null) return;
      
      const newCategory = prompt('ì¹´í…Œê³ ë¦¬:', tx.category);
      if (newCategory === null) return;
      
      const newMemo = prompt('ë©”ëª¨:', tx.memo || '');
      if (newMemo === null) return;
      
      tx.amount = Number(newAmount) || tx.amount;
      tx.category = newCategory || tx.category;
      tx.memo = newMemo;
      
      saveData();
      updateHistoryList();
      showToast('ê±°ë˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function renderStatsScreen() {
      return `
        <div class="p-4" id="stats-screen">
          <div class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
            <button onclick="setStatsPeriod('daily')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="daily">ì¼ë³„</button>
            <button onclick="setStatsPeriod('weekly')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="weekly">ì£¼ë³„</button>
            <button onclick="setStatsPeriod('monthly')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md" data-period="monthly">ì›”ë³„</button>
            <button onclick="setStatsPeriod('yearly')" class="stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200" data-period="yearly">ë…„ë„ë³„</button>
          </div>
          
          <button onclick="showAIAnalysis()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold mb-4 flex items-center justify-center gap-2 hover:from-purple-700 hover:to-indigo-700 transition shadow-lg">
            <span class="text-xl">ğŸ¤–</span>
            <span>AI ì¬ì • ë¶„ì„</span>
          </button>
          
          <div id="stats-content"></div>
          <div id="ai-analysis-content" class="hidden"></div>
        </div>
      `;
    }

    let showingAIAnalysis = false;

    function showAIAnalysis() {
      showingAIAnalysis = !showingAIAnalysis;
      const statsContent = document.getElementById('stats-content');
      const aiContent = document.getElementById('ai-analysis-content');
      
      if (showingAIAnalysis) {
        statsContent.classList.add('hidden');
        aiContent.classList.remove('hidden');
        generateAIAnalysis();
      } else {
        statsContent.classList.remove('hidden');
        aiContent.classList.add('hidden');
      }
    }

    function generateAIAnalysis() {
      const aiContent = document.getElementById('ai-analysis-content');
      const now = new Date();
      
      // ê¸°ê°„ë³„ ë°ì´í„° ìˆ˜ì§‘
      const periods = {
        thisMonth: { label: 'ì´ë²ˆ ë‹¬', transactions: [], start: new Date(now.getFullYear(), now.getMonth(), 1) },
        lastMonth: { label: 'ì§€ë‚œ ë‹¬', transactions: [], start: new Date(now.getFullYear(), now.getMonth() - 1, 1), end: new Date(now.getFullYear(), now.getMonth(), 0) },
        thisYear: { label: 'ì˜¬í•´', transactions: [], start: new Date(now.getFullYear(), 0, 1) },
        last3Months: { label: 'ìµœê·¼ 3ê°œì›”', transactions: [], start: new Date(now.getFullYear(), now.getMonth() - 2, 1) }
      };

      state.transactions.forEach(t => {
        const tDate = new Date(t.date);
        if (tDate >= periods.thisMonth.start) periods.thisMonth.transactions.push(t);
        if (tDate >= periods.lastMonth.start && tDate <= periods.lastMonth.end) periods.lastMonth.transactions.push(t);
        if (tDate >= periods.thisYear.start) periods.thisYear.transactions.push(t);
        if (tDate >= periods.last3Months.start) periods.last3Months.transactions.push(t);
      });

      // í†µê³„ ê³„ì‚° í•¨ìˆ˜
      const calcStats = (txs) => {
        const income = txs.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
        const expense = txs.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
        const necessary = txs.filter(t => t.type === 'expense' && t.isNecessary).reduce((s, t) => s + t.amount, 0);
        const unnecessary = txs.filter(t => t.type === 'expense' && !t.isNecessary).reduce((s, t) => s + t.amount, 0);
        const categories = {};
        txs.filter(t => t.type === 'expense').forEach(t => {
          categories[t.category] = (categories[t.category] || 0) + t.amount;
        });
        const incomeCategories = {};
        txs.filter(t => t.type === 'income').forEach(t => {
          incomeCategories[t.category] = (incomeCategories[t.category] || 0) + t.amount;
        });
        return { income, expense, necessary, unnecessary, categories, incomeCategories, balance: income - expense };
      };

      const thisMonthStats = calcStats(periods.thisMonth.transactions);
      const lastMonthStats = calcStats(periods.lastMonth.transactions);
      const thisYearStats = calcStats(periods.thisYear.transactions);
      const last3MonthsStats = calcStats(periods.last3Months.transactions);

      // ë³€í™”ìœ¨ ê³„ì‚°
      const expenseChange = lastMonthStats.expense > 0 
        ? ((thisMonthStats.expense - lastMonthStats.expense) / lastMonthStats.expense * 100).toFixed(1)
        : 0;
      const incomeChange = lastMonthStats.income > 0 
        ? ((thisMonthStats.income - lastMonthStats.income) / lastMonthStats.income * 100).toFixed(1)
        : 0;

      // ìƒìœ„ ì§€ì¶œ ì¹´í…Œê³ ë¦¬
      const topExpenseCategories = Object.entries(thisMonthStats.categories)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      // ìƒìœ„ ìˆ˜ì… ì¹´í…Œê³ ë¦¬
      const topIncomeCategories = Object.entries(thisMonthStats.incomeCategories)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      // ì €ì¶•ë¥  ê³„ì‚°
      const savingsRate = thisMonthStats.income > 0 
        ? ((thisMonthStats.income - thisMonthStats.expense) / thisMonthStats.income * 100).toFixed(1)
        : 0;

      // ë¶ˆí•„ìš” ì§€ì¶œ ë¹„ìœ¨
      const unnecessaryRate = thisMonthStats.expense > 0
        ? (thisMonthStats.unnecessary / thisMonthStats.expense * 100).toFixed(1)
        : 0;

      // ì›” í‰ê·  ê³„ì‚° (ìµœê·¼ 3ê°œì›”)
      const monthlyAvgExpense = Math.round(last3MonthsStats.expense / 3);
      const monthlyAvgIncome = Math.round(last3MonthsStats.income / 3);

      // AI ë¶„ì„ ë©”ì‹œì§€ ìƒì„±
      let healthScore = 100;
      const insights = [];
      const recommendations = [];

      // ì €ì¶•ë¥  ë¶„ì„
      if (savingsRate >= 30) {
        insights.push({ type: 'success', text: `ì €ì¶•ë¥  ${savingsRate}%ë¡œ ë§¤ìš° ìš°ìˆ˜í•©ë‹ˆë‹¤! ğŸ‰` });
      } else if (savingsRate >= 20) {
        insights.push({ type: 'good', text: `ì €ì¶•ë¥  ${savingsRate}%ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤.` });
      } else if (savingsRate >= 10) {
        insights.push({ type: 'warning', text: `ì €ì¶•ë¥  ${savingsRate}%ì…ë‹ˆë‹¤. ì¡°ê¸ˆ ë” ì ˆì•½ì´ í•„ìš”í•©ë‹ˆë‹¤.` });
        healthScore -= 15;
      } else if (savingsRate > 0) {
        insights.push({ type: 'danger', text: `ì €ì¶•ë¥  ${savingsRate}%ë¡œ ë‚®ìŠµë‹ˆë‹¤. ì§€ì¶œ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.` });
        healthScore -= 30;
        recommendations.push('ì§€ì¶œì„ ì¤„ì´ê³  ì €ì¶•ë¥ ì„ ìµœì†Œ 20% ì´ìƒìœ¼ë¡œ ë†’ì´ì„¸ìš”.');
      } else {
        insights.push({ type: 'danger', text: 'ì´ë²ˆ ë‹¬ ì ì ìƒíƒœì…ë‹ˆë‹¤. ê¸´ê¸‰í•œ ì§€ì¶œ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
        healthScore -= 50;
        recommendations.push('ìˆ˜ì…ë³´ë‹¤ ì§€ì¶œì´ ë§ìŠµë‹ˆë‹¤. ë¶ˆí•„ìš”í•œ ì§€ì¶œì„ ì¦‰ì‹œ ì¤„ì´ì„¸ìš”.');
      }

      // ì§€ì¶œ ë³€í™” ë¶„ì„
      if (expenseChange > 20) {
        insights.push({ type: 'danger', text: `ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ì§€ì¶œì´ ${expenseChange}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.` });
        healthScore -= 20;
        recommendations.push('ì§€ì¶œ ì¦ê°€ ì›ì¸ì„ íŒŒì•…í•˜ê³  ì˜ˆì‚°ì„ ì¬ì¡°ì •í•˜ì„¸ìš”.');
      } else if (expenseChange > 0) {
        insights.push({ type: 'warning', text: `ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ì§€ì¶œì´ ${expenseChange}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.` });
        healthScore -= 5;
      } else if (expenseChange < -10) {
        insights.push({ type: 'success', text: `ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ì§€ì¶œì´ ${Math.abs(expenseChange)}% ê°ì†Œí–ˆìŠµë‹ˆë‹¤! ğŸ‘` });
      }

      // ë¶ˆí•„ìš” ì§€ì¶œ ë¶„ì„
      if (unnecessaryRate > 30) {
        insights.push({ type: 'danger', text: `ë¶ˆí•„ìš” ì§€ì¶œì´ ì „ì²´ì˜ ${unnecessaryRate}%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤.` });
        healthScore -= 20;
        recommendations.push(`ë¶ˆí•„ìš” ì§€ì¶œ ${formatNumber(thisMonthStats.unnecessary)}ì›ì„ ì¤„ì´ë©´ ì €ì¶•ë¥ ì„ í¬ê²Œ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      } else if (unnecessaryRate > 20) {
        insights.push({ type: 'warning', text: `ë¶ˆí•„ìš” ì§€ì¶œì´ ì „ì²´ì˜ ${unnecessaryRate}%ì…ë‹ˆë‹¤.` });
        healthScore -= 10;
      } else if (unnecessaryRate <= 10) {
        insights.push({ type: 'success', text: `ë¶ˆí•„ìš” ì§€ì¶œì„ ${unnecessaryRate}%ë¡œ ì˜ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤!` });
      }

      // ìˆ˜ì… ë³€í™” ë¶„ì„
      if (incomeChange > 10) {
        insights.push({ type: 'success', text: `ìˆ˜ì…ì´ ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ${incomeChange}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤!` });
      } else if (incomeChange < -10) {
        insights.push({ type: 'warning', text: `ìˆ˜ì…ì´ ì§€ë‚œ ë‹¬ ëŒ€ë¹„ ${Math.abs(incomeChange)}% ê°ì†Œí–ˆìŠµë‹ˆë‹¤.` });
        healthScore -= 10;
      }

      // ì¶”ê°€ ê¶Œì¥ì‚¬í•­
      if (topExpenseCategories.length > 0) {
        const topCategory = topExpenseCategories[0];
        if (topCategory[1] > thisMonthStats.expense * 0.4) {
          recommendations.push(`'${topCategory[0]}' ì¹´í…Œê³ ë¦¬ê°€ ì „ì²´ ì§€ì¶œì˜ ${(topCategory[1] / thisMonthStats.expense * 100).toFixed(0)}%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤. ë¶„ì‚° ì§€ì¶œì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
        }
      }

      if (state.goals.thisYear && Number(state.goals.thisYear) > 0) {
        const totalBank = state.bankBalances.reduce((s, b) => s + b.balance, 0);
        const goalAchievement = (totalBank / Number(state.goals.thisYear) * 100).toFixed(1);
        if (goalAchievement >= 100) {
          insights.push({ type: 'success', text: `ì˜¬í•´ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ğŸŠ` });
        } else {
          insights.push({ type: 'info', text: `ì˜¬í•´ ëª©í‘œ ë‹¬ì„±ë¥ : ${goalAchievement}%` });
          if (goalAchievement < 50) {
            const remaining = Number(state.goals.thisYear) - totalBank;
            const monthsLeft = 12 - now.getMonth();
            const monthlyNeeded = Math.round(remaining / monthsLeft);
            recommendations.push(`ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•´ ë§¤ì›” ì•½ ${formatNumber(monthlyNeeded)}ì›ì˜ ì €ì¶•ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
          }
        }
      }

      healthScore = Math.max(0, Math.min(100, healthScore));
      const healthColor = healthScore >= 80 ? 'green' : healthScore >= 60 ? 'yellow' : healthScore >= 40 ? 'orange' : 'red';
      const healthEmoji = healthScore >= 80 ? 'ğŸ˜Š' : healthScore >= 60 ? 'ğŸ™‚' : healthScore >= 40 ? 'ğŸ˜' : 'ğŸ˜Ÿ';

      aiContent.innerHTML = `
        <div class="space-y-4 animate-fade-in">
          <button onclick="showAIAnalysis()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium mb-2 flex items-center justify-center gap-2 hover:bg-gray-300 transition">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            í†µê³„ë¡œ ëŒì•„ê°€ê¸°
          </button>

          <!-- ì¬ì • ê±´ê°•ë„ -->
          <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-5 rounded-xl shadow-lg">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-bold text-lg flex items-center gap-2">
                <span>ğŸ¤–</span> AI ì¬ì • ê±´ê°•ë„ ë¶„ì„
              </h3>
              <span class="text-3xl">${healthEmoji}</span>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full h-6 mb-2 overflow-hidden">
              <div class="h-6 rounded-full bg-white flex items-center justify-end pr-2 transition-all" style="width: ${healthScore}%">
                <span class="text-${healthColor}-600 font-bold text-sm">${healthScore}ì </span>
              </div>
            </div>
            <div class="text-sm opacity-90">
              ${healthScore >= 80 ? 'ì¬ì • ìƒíƒœê°€ ë§¤ìš° ê±´ê°•í•©ë‹ˆë‹¤!' : 
                healthScore >= 60 ? 'ì¬ì • ê´€ë¦¬ë¥¼ ì˜ í•˜ê³  ê³„ì‹œì§€ë§Œ ê°œì„ ì˜ ì—¬ì§€ê°€ ìˆìŠµë‹ˆë‹¤.' :
                healthScore >= 40 ? 'ì¬ì • ê´€ë¦¬ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.' :
                'ì¦‰ê°ì ì¸ ì¬ì • ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.'}
            </div>
          </div>

          <!-- ì´ë²ˆ ë‹¬ ìš”ì•½ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4 flex items-center gap-2">
              <span>ğŸ“Š</span> ì´ë²ˆ ë‹¬ ìš”ì•½
            </h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
              <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                <div class="text-xs text-green-600">ì´ ìˆ˜ì…</div>
                <div class="text-lg font-bold text-green-700">${formatNumber(thisMonthStats.income)}ì›</div>
                <div class="text-xs ${Number(incomeChange) >= 0 ? 'text-green-500' : 'text-red-500'}">
                  ${Number(incomeChange) >= 0 ? 'â–²' : 'â–¼'} ì „ì›” ëŒ€ë¹„ ${Math.abs(incomeChange)}%
                </div>
              </div>
              <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                <div class="text-xs text-red-600">ì´ ì§€ì¶œ</div>
                <div class="text-lg font-bold text-red-700">${formatNumber(thisMonthStats.expense)}ì›</div>
                <div class="text-xs ${Number(expenseChange) <= 0 ? 'text-green-500' : 'text-red-500'}">
                  ${Number(expenseChange) >= 0 ? 'â–²' : 'â–¼'} ì „ì›” ëŒ€ë¹„ ${Math.abs(expenseChange)}%
                </div>
              </div>
              <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <div class="text-xs text-blue-600">ì €ì¶•ë¥ </div>
                <div class="text-lg font-bold text-blue-700">${savingsRate}%</div>
                <div class="text-xs text-gray-500">ê¶Œì¥: 20% ì´ìƒ</div>
              </div>
              <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                <div class="text-xs text-purple-600">ìˆœì´ìµ</div>
                <div class="text-lg font-bold ${thisMonthStats.balance >= 0 ? 'text-purple-700' : 'text-red-700'}">
                  ${thisMonthStats.balance >= 0 ? '+' : ''}${formatNumber(thisMonthStats.balance)}ì›
                </div>
              </div>
            </div>

            <!-- í•„ìš”/ë¶ˆí•„ìš” ì§€ì¶œ ë¶„ì„ -->
            <div class="bg-gray-50 p-3 rounded-lg mb-3">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium">ì§€ì¶œ êµ¬ì„±</span>
              </div>
              <div class="flex gap-2 h-8 rounded-lg overflow-hidden">
                ${thisMonthStats.expense > 0 ? `
                  <div class="bg-blue-500 flex items-center justify-center text-white text-xs font-bold" style="width: ${100 - unnecessaryRate}%">
                    í•„ìš” ${(100 - unnecessaryRate).toFixed(0)}%
                  </div>
                  <div class="bg-gray-400 flex items-center justify-center text-white text-xs font-bold" style="width: ${unnecessaryRate}%">
                    ë¶ˆí•„ìš” ${unnecessaryRate}%
                  </div>
                ` : '<div class="w-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs">ë°ì´í„° ì—†ìŒ</div>'}
              </div>
            </div>
          </div>

          <!-- AI ì¸ì‚¬ì´íŠ¸ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4 flex items-center gap-2">
              <span>ğŸ’¡</span> AI ì¸ì‚¬ì´íŠ¸
            </h3>
            <div class="space-y-2">
              ${insights.map(i => `
                <div class="flex items-start gap-2 p-2 rounded-lg ${
                  i.type === 'success' ? 'bg-green-50 text-green-700' :
                  i.type === 'good' ? 'bg-blue-50 text-blue-700' :
                  i.type === 'warning' ? 'bg-yellow-50 text-yellow-700' :
                  i.type === 'danger' ? 'bg-red-50 text-red-700' :
                  'bg-gray-50 text-gray-700'
                }">
                  <span class="text-lg">${
                    i.type === 'success' ? 'âœ…' :
                    i.type === 'good' ? 'ğŸ‘' :
                    i.type === 'warning' ? 'âš ï¸' :
                    i.type === 'danger' ? 'ğŸš¨' : 'â„¹ï¸'
                  }</span>
                  <span class="text-sm">${i.text}</span>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- ê¶Œì¥ì‚¬í•­ -->
          ${recommendations.length > 0 ? `
            <div class="bg-white rounded-xl shadow-lg p-4">
              <h3 class="font-bold mb-4 flex items-center gap-2">
                <span>ğŸ¯</span> AI ê¶Œì¥ì‚¬í•­
              </h3>
              <div class="space-y-2">
                ${recommendations.map((r, i) => `
                  <div class="flex items-start gap-2 p-3 bg-indigo-50 rounded-lg">
                    <span class="bg-indigo-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">${i + 1}</span>
                    <span class="text-sm text-indigo-700">${r}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- ìƒìœ„ ì§€ì¶œ ì¹´í…Œê³ ë¦¬ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4 flex items-center gap-2">
              <span>ğŸ“‰</span> ì´ë²ˆ ë‹¬ ìƒìœ„ ì§€ì¶œ ì¹´í…Œê³ ë¦¬
            </h3>
            ${topExpenseCategories.length > 0 ? `
              <div class="space-y-3">
                ${topExpenseCategories.map(([cat, amount], idx) => {
                  const percent = (amount / thisMonthStats.expense * 100).toFixed(1);
                  return `
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${idx + 1}. ${cat}</span>
                        <span class="text-gray-600">${formatNumber(amount)}ì› (${percent}%)</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-red-400 to-red-500 h-3 rounded-full" style="width: ${percent}%"></div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : '<div class="text-center text-gray-400 py-4">ì§€ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'}
          </div>

          <!-- ìƒìœ„ ìˆ˜ì… ì¹´í…Œê³ ë¦¬ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4 flex items-center gap-2">
              <span>ğŸ“ˆ</span> ì´ë²ˆ ë‹¬ ìˆ˜ì… êµ¬ì„±
            </h3>
            ${topIncomeCategories.length > 0 ? `
              <div class="space-y-3">
                ${topIncomeCategories.map(([cat, amount], idx) => {
                  const percent = (amount / thisMonthStats.income * 100).toFixed(1);
                  return `
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium">${idx + 1}. ${cat}</span>
                        <span class="text-gray-600">${formatNumber(amount)}ì› (${percent}%)</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-green-400 to-green-500 h-3 rounded-full" style="width: ${percent}%"></div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : '<div class="text-center text-gray-400 py-4">ìˆ˜ì… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>'}
          </div>

          <!-- ê¸°ê°„ë³„ ë¹„êµ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4 flex items-center gap-2">
              <span>ğŸ“…</span> ê¸°ê°„ë³„ ë¹„êµ
            </h3>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="p-2 text-left">ê¸°ê°„</th>
                    <th class="p-2 text-right">ìˆ˜ì…</th>
                    <th class="p-2 text-right">ì§€ì¶œ</th>
                    <th class="p-2 text-right">ìˆœì´ìµ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="border-b">
                    <td class="p-2 font-medium">ì´ë²ˆ ë‹¬</td>
                    <td class="p-2 text-right text-green-600">${formatNumber(thisMonthStats.income)}</td>
                    <td class="p-2 text-right text-red-600">${formatNumber(thisMonthStats.expense)}</td>
                    <td class="p-2 text-right ${thisMonthStats.balance >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatNumber(thisMonthStats.balance)}</td>
                  </tr>
                  <tr class="border-b">
                    <td class="p-2 font-medium">ì§€ë‚œ ë‹¬</td>
                    <td class="p-2 text-right text-green-600">${formatNumber(lastMonthStats.income)}</td>
                    <td class="p-2 text-right text-red-600">${formatNumber(lastMonthStats.expense)}</td>
                    <td class="p-2 text-right ${lastMonthStats.balance >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatNumber(lastMonthStats.balance)}</td>
                  </tr>
                  <tr class="border-b">
                    <td class="p-2 font-medium">ì›” í‰ê·  (3ê°œì›”)</td>
                    <td class="p-2 text-right text-green-600">${formatNumber(monthlyAvgIncome)}</td>
                    <td class="p-2 text-right text-red-600">${formatNumber(monthlyAvgExpense)}</td>
                    <td class="p-2 text-right ${monthlyAvgIncome - monthlyAvgExpense >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatNumber(monthlyAvgIncome - monthlyAvgExpense)}</td>
                  </tr>
                  <tr>
                    <td class="p-2 font-medium">ì˜¬í•´ ëˆ„ì </td>
                    <td class="p-2 text-right text-green-600">${formatNumber(thisYearStats.income)}</td>
                    <td class="p-2 text-right text-red-600">${formatNumber(thisYearStats.expense)}</td>
                    <td class="p-2 text-right ${thisYearStats.balance >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatNumber(thisYearStats.balance)}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ë¶„ì„ ì‹œê°„ -->
          <div class="text-center text-xs text-gray-400 pb-4">
            ğŸ¤– AI ë¶„ì„ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}
          </div>
        </div>
      `;

      lucide.createIcons();
    }

    let statsPeriod = 'monthly';

    function setStatsPeriod(period) {
      statsPeriod = period;
      document.querySelectorAll('.stats-btn').forEach(btn => {
        btn.className = btn.dataset.period === period 
          ? 'stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-blue-500 text-white shadow-md'
          : 'stats-btn px-4 py-2 rounded-lg whitespace-nowrap transition bg-gray-200';
      });
      updateStatsContent();
    }

    function updateStatsContent() {
      const now = new Date();
      const filtered = state.transactions.filter(t => {
        const d = new Date(t.date);
        if (statsPeriod === 'daily') return d.toDateString() === now.toDateString();
        if (statsPeriod === 'weekly') return d >= new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        if (statsPeriod === 'monthly') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        return d.getFullYear() === now.getFullYear();
      });

      const categoryStats = {};
      filtered.forEach(t => {
        if (!categoryStats[t.category]) categoryStats[t.category] = { income: 0, expense: 0 };
        if (t.type === 'income') categoryStats[t.category].income += t.amount;
        else categoryStats[t.category].expense += t.amount;
      });

      const totalIncome = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const totalExpense = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const maxAmount = Math.max(totalIncome, totalExpense, 1);

      const contentEl = document.getElementById('stats-content');
      if (!contentEl) return;

      contentEl.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <h3 class="font-bold mb-4">ìˆ˜ì… / ì§€ì¶œ í•©ê³„</h3>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-green-600 font-medium">ìˆ˜ì…</span>
                <span class="text-green-600 font-bold">${formatNumber(totalIncome)}ì›</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6">
                <div class="bg-gradient-to-r from-green-400 to-green-500 h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ${(totalIncome / maxAmount) * 100}%">
                  <span class="text-xs text-white font-bold">${Math.round((totalIncome / maxAmount) * 100)}%</span>
                </div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-sm mb-1">
                <span class="text-red-600 font-medium">ì§€ì¶œ</span>
                <span class="text-red-600 font-bold">${formatNumber(totalExpense)}ì›</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6">
                <div class="bg-gradient-to-r from-red-400 to-red-500 h-6 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ${(totalExpense / maxAmount) * 100}%">
                  <span class="text-xs text-white font-bold">${Math.round((totalExpense / maxAmount) * 100)}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-4">
          <h3 class="font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ í†µê³„</h3>
          <div class="space-y-3">
            ${Object.keys(categoryStats).length === 0 ? '<div class="text-center text-gray-400 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>' :
              Object.entries(categoryStats).map(([cat, amounts]) => `
                <div class="border-b pb-3">
                  <div class="font-medium mb-2">${cat}</div>
                  ${amounts.income > 0 ? `
                    <div class="mb-1">
                      <div class="flex justify-between text-xs mb-1">
                        <span class="text-green-600">ìˆ˜ì…</span>
                        <span class="text-green-600 font-bold">${formatNumber(amounts.income)}ì›</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-green-400 h-4 rounded-full transition-all" style="width: ${(amounts.income / maxAmount) * 100}%"></div>
                      </div>
                    </div>
                  ` : ''}
                  ${amounts.expense > 0 ? `
                    <div>
                      <div class="flex justify-between text-xs mb-1">
                        <span class="text-red-600">ì§€ì¶œ</span>
                        <span class="text-red-600 font-bold">${formatNumber(amounts.expense)}ì›</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-red-400 h-4 rounded-full transition-all" style="width: ${(amounts.expense / maxAmount) * 100}%"></div>
                      </div>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
          </div>
        </div>
      `;
    }

    function renderGoalScreen() {
      const totalBank = state.bankBalances.reduce((s, b) => s + b.balance, 0);
      const calcAchievement = (goal) => {
        const g = Number(goal) || 0;
        return g === 0 ? 0 : Math.min((totalBank / g) * 100, 100);
      };

      const goalData = [
        { label: '7ë…„ ëª©í‘œ', key: 'year7', icon: 'ğŸ‘‘', color: 'purple' },
        { label: '5ë…„ ëª©í‘œ', key: 'year5', icon: 'ğŸ’', color: 'blue' },
        { label: '3ë…„ ëª©í‘œ', key: 'year3', icon: 'ğŸ†', color: 'green' },
        { label: 'ì˜¬í•´ ëª©í‘œ', key: 'thisYear', icon: 'â­', color: 'yellow' }
      ];

      return `
        <div class="p-4 space-y-6">
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ìˆ˜ì… ëª©í‘œ</h3>
            <div class="space-y-3">
              ${goalData.map(g => `
                <div>
                  <label class="block text-sm font-medium mb-1 text-${g.color}-700">${g.icon} ${g.label}</label>
                  <div class="relative">
                    <input type="number" id="goal-${g.key}" value="${state.goals[g.key]}" class="w-full p-2 pr-8 border-2 border-${g.color}-300 rounded-lg bg-${g.color}-50 focus:border-${g.color}-500 focus:outline-none" placeholder="ê¸ˆì•¡ ì…ë ¥">
                    <span class="absolute right-3 top-2.5 text-gray-500 text-sm">ì›</span>
                  </div>
                </div>
              `).join('')}
              <button onclick="saveGoals()" class="w-full bg-blue-500 text-white py-2 rounded-lg font-medium hover:bg-blue-600 transition shadow-md">ëª©í‘œ ì €ì¥</button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ëª©í‘œ ë‹¬ì„± í˜„í™©</h3>
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg mb-4">
              <div class="text-sm text-blue-600">í˜„ì¬ í†µì¥ ì”ê³ </div>
              <div class="text-2xl font-bold text-blue-700">${formatNumber(totalBank)}ì›</div>
            </div>
            <div class="space-y-4">
              ${goalData.filter(g => Number(state.goals[g.key]) > 0).map(g => {
                const goalAmt = Number(state.goals[g.key]);
                const ach = calcAchievement(state.goals[g.key]);
                const remaining = Math.max(0, goalAmt - totalBank);
                const barColor = ach >= 100 ? 'from-green-400 to-green-500' : ach >= 75 ? 'from-blue-400 to-blue-500' : ach >= 50 ? 'from-yellow-400 to-yellow-500' : 'from-orange-400 to-orange-500';
                return `
                  <div class="border-b pb-4 last:border-b-0">
                    <div class="flex justify-between items-center mb-2">
                      <span class="font-medium text-gray-700">${g.label}</span>
                      <span class="text-sm text-gray-600">${formatNumber(totalBank)} / ${formatNumber(goalAmt)}ì›</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-8 mb-2 relative overflow-hidden">
                      <div class="h-8 rounded-full flex items-center justify-end pr-3 transition-all bg-gradient-to-r ${barColor}" style="width: ${ach}%">
                        <span class="text-white font-bold text-sm">${ach.toFixed(1)}%</span>
                      </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600">
                      <span>ë‹¬ì„±ë¥ : ${ach.toFixed(1)}%</span>
                      ${remaining > 0 ? `<span class="text-red-600">ëª©í‘œê¹Œì§€: ${formatNumber(remaining)}ì›</span>` : ''}
                      ${ach >= 100 ? '<span class="text-green-600 font-bold">âœ“ ëª©í‘œ ë‹¬ì„±!</span>' : ''}
                    </div>
                  </div>
                `;
              }).join('') || '<div class="text-center text-gray-400 py-4">ëª©í‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</div>'}
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ì€í–‰ë³„ í†µí•©ì”ê³ </h3>
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg mb-4">
              <div class="text-sm text-blue-600">ì´ ì”ê³ </div>
              <div class="text-2xl font-bold text-blue-700">${formatNumber(totalBank)}ì›</div>
            </div>
            <div class="space-y-2 mb-4" id="bank-list">
              ${state.bankBalances.map(b => `
                <div class="flex justify-between items-center p-3 border rounded-lg bg-gray-50">
                  <div><div class="font-medium">${b.name}</div><div class="text-sm text-gray-600">${formatNumber(b.balance)}ì›</div></div>
                  <button onclick="deleteBank(${b.id})" class="text-red-500 text-sm px-2 py-1 hover:bg-red-50 rounded">ì‚­ì œ</button>
                </div>
              `).join('')}
            </div>
            <div class="space-y-2">
              <input type="text" id="newBankName" class="w-full p-2 border rounded-lg" placeholder="ì€í–‰ëª…">
              <input type="number" id="newBankBalance" class="w-full p-2 border rounded-lg" placeholder="ì”ê³ ">
              <button onclick="addBank()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition shadow-md">ì€í–‰ ì¶”ê°€</button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ì¼ì¼ ë©”ëª¨ì¥</h3>
            <input type="date" id="searchMemoDate" class="w-full p-2 border rounded-lg mb-2" placeholder="ë‚ ì§œ ê²€ìƒ‰" onchange="filterMemos()">
            <div class="space-y-3 mb-4 max-h-64 overflow-y-auto" id="memo-list"></div>
            <div class="space-y-2">
              <input type="date" id="memoDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg">
              <textarea id="memoContent" class="w-full p-2 border rounded-lg" rows="4" placeholder="ì˜¤ëŠ˜ì˜ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”"></textarea>
              <button onclick="addMemo()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition shadow-md">ë©”ëª¨ ì¶”ê°€</button>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ğŸ“… í–‰ì‚¬ì¼ì • ìº˜ë¦°ë”</h3>
            <div class="space-y-3 mb-4 max-h-64 overflow-y-auto" id="event-list"></div>
            <div class="space-y-2 border-t pt-4">
              <input type="text" id="eventTitle" class="w-full p-2 border rounded-lg" placeholder="í–‰ì‚¬ ì œëª©">
              <input type="date" id="eventDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg">
              <input type="text" id="eventDesc" class="w-full p-2 border rounded-lg" placeholder="í–‰ì‚¬ ì„¤ëª… (ì„ íƒì‚¬í•­)">
              <button onclick="addEvent()" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition shadow-md">í–‰ì‚¬ ì¶”ê°€</button>
            </div>
          </div>
        </div>
      `;
    }

    function saveGoals() {
      state.goals = {
        year7: document.getElementById('goal-year7')?.value || '',
        year5: document.getElementById('goal-year5')?.value || '',
        year3: document.getElementById('goal-year3')?.value || '',
        thisYear: document.getElementById('goal-thisYear')?.value || ''
      };
      saveData();
      showToast('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
      render();
    }

    function addBank() {
      const name = document.getElementById('newBankName')?.value;
      const balance = Number(document.getElementById('newBankBalance')?.value);
      if (!name || isNaN(balance)) { alert('ì€í–‰ëª…ê³¼ ì”ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.bankBalances.push({ id: Date.now(), name, balance });
      saveData();
      render();
      showToast('ì€í–‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteBank(id) {
      if (confirm('ì€í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.bankBalances = state.bankBalances.filter(b => b.id !== id);
        saveData();
        render();
        showToast('ì€í–‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function addMemo() {
      const date = document.getElementById('memoDate')?.value;
      const content = document.getElementById('memoContent')?.value;
      if (!content) return;
      state.memos.push({ id: Date.now(), date, content });
      saveData();
      document.getElementById('memoContent').value = '';
      filterMemos();
      showToast('ë©”ëª¨ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteMemo(id) {
      if (confirm('ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const memo = state.memos.find(m => m.id === id);
        if (memo) addToUndoStack('deleteMemo', memo);
        state.memos = state.memos.filter(m => m.id !== id);
        saveData();
        filterMemos();
        showToast('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function filterMemos() {
      const searchDate = document.getElementById('searchMemoDate')?.value || '';
      const filtered = state.memos.filter(m => !searchDate || m.date.includes(searchDate));
      const listEl = document.getElementById('memo-list');
      if (!listEl) return;
      listEl.innerHTML = filtered.length === 0 ? '<div class="text-center text-gray-400 py-4">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</div>' :
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).map(m => `
          <div class="border rounded-lg p-3 bg-yellow-50">
            <div class="flex justify-between items-start mb-2">
              <div class="text-sm text-gray-600">${m.date}</div>
              <button onclick="deleteMemo(${m.id})" class="text-red-500 text-sm">ì‚­ì œ</button>
            </div>
            <div class="text-gray-800 whitespace-pre-wrap">${m.content}</div>
          </div>
        `).join('');
    }

    function addEvent() {
      const title = document.getElementById('eventTitle')?.value;
      const date = document.getElementById('eventDate')?.value;
      const description = document.getElementById('eventDesc')?.value || '';
      if (!title || !date) { alert('í–‰ì‚¬ ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.events.push({ id: Date.now(), title, date, description });
      saveData();
      document.getElementById('eventTitle').value = '';
      document.getElementById('eventDesc').value = '';
      updateEventList();
      showToast('í–‰ì‚¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteEvent(id) {
      if (confirm('ì´ í–‰ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.events = state.events.filter(e => e.id !== id);
        saveData();
        updateEventList();
        showToast('í–‰ì‚¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function updateEventList() {
      const listEl = document.getElementById('event-list');
      if (!listEl) return;
      const today = new Date(); today.setHours(0, 0, 0, 0);
      listEl.innerHTML = state.events.length === 0 ? '<div class="text-center text-gray-400 py-4">ë“±ë¡ëœ í–‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>' :
        state.events.sort((a, b) => new Date(a.date) - new Date(b.date)).map(e => {
          const eventDate = new Date(e.date); eventDate.setHours(0, 0, 0, 0);
          const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
          const isPast = daysUntil < 0, isToday = daysUntil === 0, isUpcoming = daysUntil > 0 && daysUntil <= 7;
          const bgClass = isPast ? 'bg-gray-50 opacity-60' : isToday ? 'bg-red-50 border-red-300' : isUpcoming ? 'bg-yellow-50 border-yellow-300' : 'bg-white';
          return `
            <div class="border rounded-lg p-3 ${bgClass}">
              <div class="flex justify-between items-start mb-2">
                <div class="flex-1"><div class="font-bold text-gray-800">${e.title}</div><div class="text-sm text-gray-600 mt-1">${e.date}</div>${e.description ? `<div class="text-sm text-gray-500 mt-1">${e.description}</div>` : ''}</div>
                <button onclick="deleteEvent(${e.id})" class="text-red-500 text-sm ml-2">ì‚­ì œ</button>
              </div>
              <div class="flex items-center gap-2 text-xs">
                ${isPast ? '<span class="text-gray-500">ì¢…ë£Œë¨</span>' : isToday ? '<span class="text-red-600 font-bold">ğŸ”” ì˜¤ëŠ˜!</span>' : isUpcoming ? `<span class="text-orange-600 font-bold">âš ï¸ ${daysUntil}ì¼ ë‚¨ìŒ</span>` : `<span class="text-blue-600">ğŸ“ ${daysUntil}ì¼ ë‚¨ìŒ</span>`}
              </div>
            </div>
          `;
        }).join('');
    }

    // Investment Screen
    function renderInvestmentScreen() {
      const totalInvested = state.investments.reduce((s, i) => s + i.buyPrice * i.quantity, 0);
      const totalCurrentValue = state.investments.reduce((s, i) => s + i.currentPrice * i.quantity, 0);
      const totalProfit = totalCurrentValue - totalInvested;
      const totalProfitRate = totalInvested > 0 ? ((totalProfit / totalInvested) * 100) : 0;
      const totalDividends = state.dividends.reduce((s, d) => s + d.amount, 0);

      const thisYearDividends = state.dividends.filter(d => {
        const dDate = new Date(d.date);
        return dDate.getFullYear() === new Date().getFullYear();
      }).reduce((s, d) => s + d.amount, 0);

      return `
        <div class="p-4 space-y-6">
          <!-- íˆ¬ì ìš”ì•½ -->
          <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
            <div class="text-sm opacity-90 mb-1">ğŸ“Š ì´ íˆ¬ì í˜„í™©</div>
            <div class="text-2xl font-bold mb-2">${formatNumber(totalCurrentValue)}ì›</div>
            <div class="grid grid-cols-2 gap-4 mt-4">
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <div class="text-xs opacity-80">íˆ¬ì ì›ê¸ˆ</div>
                <div class="font-bold">${formatNumber(totalInvested)}ì›</div>
              </div>
              <div class="bg-white bg-opacity-20 rounded-lg p-3">
                <div class="text-xs opacity-80">í‰ê°€ ì†ìµ</div>
                <div class="font-bold ${totalProfit >= 0 ? 'text-green-300' : 'text-red-300'}">
                  ${totalProfit >= 0 ? '+' : ''}${formatNumber(totalProfit)}ì› (${totalProfitRate >= 0 ? '+' : ''}${totalProfitRate.toFixed(2)}%)
                </div>
              </div>
            </div>
          </div>

          <!-- ë°°ë‹¹ê¸ˆ ìš”ì•½ -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-green-50 p-4 rounded-lg border border-green-200 shadow-sm">
              <div class="text-xs text-green-600 mb-1">ğŸ’° ì´ ë°°ë‹¹ê¸ˆ</div>
              <div class="text-xl font-bold text-green-700">${formatNumber(totalDividends)}ì›</div>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 shadow-sm">
              <div class="text-xs text-blue-600 mb-1">ğŸ“… ì˜¬í•´ ë°°ë‹¹ê¸ˆ</div>
              <div class="text-xl font-bold text-blue-700">${formatNumber(thisYearDividends)}ì›</div>
            </div>
          </div>

          <!-- í¬íŠ¸í´ë¦¬ì˜¤ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold">ğŸ“ˆ ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h3>
              <button onclick="state.showAddInvestment=true;render()" class="bg-indigo-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-indigo-600 transition">+ ì¢…ëª© ì¶”ê°€</button>
            </div>
            <div class="space-y-3" id="investment-list">
              ${state.investments.length === 0 ? '<div class="text-center text-gray-400 py-8">ë“±ë¡ëœ íˆ¬ì ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>' :
                state.investments.map(inv => {
                  const invested = inv.buyPrice * inv.quantity;
                  const current = inv.currentPrice * inv.quantity;
                  const profit = current - invested;
                  const profitRate = invested > 0 ? ((profit / invested) * 100) : 0;
                  const typeIcons = { stock: 'ğŸ“Š', etf: 'ğŸ“¦', fund: 'ğŸ’¼', crypto: 'ğŸª™', gold: 'ğŸ¥‡', realestate: 'ğŸ ', bond: 'ğŸ“ƒ', other: 'ğŸ“„' };
                  const typeLabels = { stock: 'ì£¼ì‹', etf: 'ETF', fund: 'í€ë“œ', crypto: 'ì•”í˜¸í™”í', gold: 'ê¸ˆ', realestate: 'ë¶€ë™ì‚°', bond: 'ì±„ê¶Œ', other: 'ê¸°íƒ€' };
                  const typeIcon = typeIcons[inv.type] || 'ğŸ“„';
                  const typeLabel = typeLabels[inv.type] || 'ê¸°íƒ€';
                  
                  return `
                    <div class="border rounded-lg p-4 bg-gray-50">
                      <div class="flex justify-between items-start mb-2">
                        <div>
                          <div class="flex items-center gap-2">
                            <span class="text-lg">${typeIcon}</span>
                            <span class="font-bold text-gray-800">${inv.name}</span>
                            <span class="text-xs bg-gray-200 px-2 py-0.5 rounded">${typeLabel}</span>
                          </div>
                          <div class="text-sm text-gray-500 mt-1">${inv.quantity}ì£¼ ë³´ìœ </div>
                        </div>
                        <div class="text-right">
                          <div class="font-bold ${profit >= 0 ? 'text-red-600' : 'text-blue-600'}">
                            ${profit >= 0 ? '+' : ''}${formatNumber(profit)}ì›
                          </div>
                          <div class="text-sm ${profit >= 0 ? 'text-red-500' : 'text-blue-500'}">
                            ${profitRate >= 0 ? '+' : ''}${profitRate.toFixed(2)}%
                          </div>
                        </div>
                      </div>
                      <div class="grid grid-cols-3 gap-2 text-sm mt-3 pt-3 border-t">
                        <div>
                          <div class="text-gray-500 text-xs">ë§¤ì…ê°€</div>
                          <div class="font-medium">${formatNumber(inv.buyPrice)}ì›</div>
                        </div>
                        <div>
                          <div class="text-gray-500 text-xs">í˜„ì¬ê°€</div>
                          <div class="font-medium">${formatNumber(inv.currentPrice)}ì›</div>
                        </div>
                        <div>
                          <div class="text-gray-500 text-xs">í‰ê°€ê¸ˆì•¡</div>
                          <div class="font-medium">${formatNumber(current)}ì›</div>
                        </div>
                      </div>
                      <div class="flex gap-2 mt-3 pt-3 border-t">
                        <button onclick="editInvestmentPrice(${inv.id})" class="flex-1 text-blue-500 text-sm py-1 hover:bg-blue-50 rounded">í˜„ì¬ê°€ ìˆ˜ì •</button>
                        <button onclick="deleteInvestment(${inv.id})" class="flex-1 text-red-500 text-sm py-1 hover:bg-red-50 rounded">ì‚­ì œ</button>
                      </div>
                    </div>
                  `;
                }).join('')}
            </div>
          </div>

          <!-- ë°°ë‹¹ê¸ˆ ë‚´ì—­ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold">ğŸ’µ ë°°ë‹¹ê¸ˆ ë‚´ì—­</h3>
            </div>
            <div class="space-y-2 mb-4 max-h-64 overflow-y-auto" id="dividend-list">
              ${state.dividends.length === 0 ? '<div class="text-center text-gray-400 py-4">ë°°ë‹¹ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>' :
                state.dividends.sort((a, b) => new Date(b.date) - new Date(a.date)).map(d => `
                  <div class="flex justify-between items-center p-3 border rounded-lg bg-green-50">
                    <div>
                      <div class="font-medium">${d.stockName}</div>
                      <div class="text-xs text-gray-500">${d.date}</div>
                    </div>
                    <div class="flex items-center gap-2">
                      <div class="font-bold text-green-600">+${formatNumber(d.amount)}ì›</div>
                      <button onclick="deleteDividend(${d.id})" class="text-red-500 text-sm px-2">ì‚­ì œ</button>
                    </div>
                  </div>
                `).join('')}
            </div>
            <div class="space-y-2 border-t pt-4">
              <input type="text" id="dividendStock" class="w-full p-2 border rounded-lg" placeholder="ì¢…ëª©ëª…">
              <div class="grid grid-cols-2 gap-2">
                <input type="date" id="dividendDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg">
                <input type="number" id="dividendAmount" class="w-full p-2 border rounded-lg" placeholder="ë°°ë‹¹ê¸ˆì•¡">
              </div>
              <button onclick="addDividend()" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition shadow-md">ë°°ë‹¹ê¸ˆ ì¶”ê°€</button>
            </div>
          </div>

          <!-- íˆ¬ì ë©”ëª¨ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold mb-4">ğŸ“ íˆ¬ì ì¼ì§€</h3>
            <div class="space-y-3 mb-4 max-h-64 overflow-y-auto" id="invest-memo-list"></div>
            <div class="space-y-2">
              <input type="date" id="investMemoDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg">
              <textarea id="investMemoContent" class="w-full p-2 border rounded-lg" rows="3" placeholder="ì˜¤ëŠ˜ì˜ íˆ¬ì ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”"></textarea>
              <button onclick="addInvestMemo()" class="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 transition shadow-md">ë©”ëª¨ ì¶”ê°€</button>
            </div>
          </div>
        </div>
      `;
    }

    function addInvestment() {
      const name = document.getElementById('invName')?.value;
      const type = document.getElementById('invType')?.value;
      const quantity = Number(document.getElementById('invQuantity')?.value);
      const buyPrice = Number(document.getElementById('invBuyPrice')?.value);
      const currentPrice = Number(document.getElementById('invCurrentPrice')?.value) || buyPrice;
      const buyDate = document.getElementById('invBuyDate')?.value;

      if (!name || !quantity || !buyPrice) {
        alert('ì¢…ëª©ëª…, ìˆ˜ëŸ‰, ë§¤ì…ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      state.investments.push({
        id: Date.now(),
        name,
        type,
        quantity,
        buyPrice,
        currentPrice,
        buyDate
      });

      state.showAddInvestment = false;
      saveData();
      render();
      showToast('íˆ¬ì ì¢…ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function editInvestmentPrice(id) {
      const inv = state.investments.find(i => i.id === id);
      if (!inv) return;

      const newPrice = prompt('í˜„ì¬ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', inv.currentPrice);
      if (newPrice === null) return;

      const price = Number(newPrice);
      if (isNaN(price) || price < 0) {
        alert('ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      inv.currentPrice = price;
      saveData();
      render();
      showToast('í˜„ì¬ê°€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteInvestment(id) {
      if (confirm('ì´ íˆ¬ì ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.investments = state.investments.filter(i => i.id !== id);
        saveData();
        render();
        showToast('íˆ¬ì ì¢…ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function addDividend() {
      const stockName = document.getElementById('dividendStock')?.value;
      const date = document.getElementById('dividendDate')?.value;
      const amount = Number(document.getElementById('dividendAmount')?.value);

      if (!stockName || !amount) {
        alert('ì¢…ëª©ëª…ê³¼ ë°°ë‹¹ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }

      state.dividends.push({
        id: Date.now(),
        stockName,
        date,
        amount
      });

      document.getElementById('dividendStock').value = '';
      document.getElementById('dividendAmount').value = '';
      saveData();
      render();
      showToast('ë°°ë‹¹ê¸ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteDividend(id) {
      if (confirm('ì´ ë°°ë‹¹ê¸ˆ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.dividends = state.dividends.filter(d => d.id !== id);
        saveData();
        render();
        showToast('ë°°ë‹¹ê¸ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function addInvestMemo() {
      const date = document.getElementById('investMemoDate')?.value;
      const content = document.getElementById('investMemoContent')?.value;
      if (!content) return;

      state.memos.push({ id: Date.now(), date, content, type: 'invest' });
      saveData();
      document.getElementById('investMemoContent').value = '';
      updateInvestMemoList();
      showToast('íˆ¬ì ë©”ëª¨ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function updateInvestMemoList() {
      const listEl = document.getElementById('invest-memo-list');
      if (!listEl) return;
      const investMemos = state.memos.filter(m => m.type === 'invest');
      listEl.innerHTML = investMemos.length === 0 ? '<div class="text-center text-gray-400 py-4">íˆ¬ì ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</div>' :
        investMemos.sort((a, b) => new Date(b.date) - new Date(a.date)).map(m => `
          <div class="border rounded-lg p-3 bg-indigo-50">
            <div class="flex justify-between items-start mb-2">
              <div class="text-sm text-gray-600">${m.date}</div>
              <button onclick="deleteMemo(${m.id})" class="text-red-500 text-sm">ì‚­ì œ</button>
            </div>
            <div class="text-gray-800 whitespace-pre-wrap">${m.content}</div>
          </div>
        `).join('');
    }

    function renderExchangeScreen() {
      const phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      const currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      const sym = state.exchangeTab === 'USD' ? '$' : 'Â¥';
      const initialBudget = 10000000;

      // Calculate totals
      const totalUsd = state.usdPhases.reduce((s, p) => s + (p.amount / p.buyRate), 0);
      const totalJpy = state.jpyPhases.reduce((s, p) => s + (p.amount / p.buyRate), 0);
      const cumInvested = [...state.usdPhases, ...state.jpyPhases].reduce((s, p) => s + p.amount, 0);
      
      const invested = phases.filter(p => p.completed && !p.sold).reduce((s, p) => s + p.amount, 0);
      const foreign = phases.filter(p => p.completed && !p.sold).reduce((s, p) => s + (p.amount / p.buyRate), 0);
      const avgRate = foreign > 0 ? (invested / foreign).toFixed(2) : 0;
      const unrealized = phases.filter(p => p.completed && !p.sold).reduce((s, p) => s + ((p.amount / p.buyRate) * currentRate - p.amount), 0);
      const profit = phases.filter(p => p.sold).reduce((s, p) => s + ((p.amount / p.buyRate) * p.sellRate - p.amount), 0);

      const sorted = [...phases].sort((a, b) => a.sold && !b.sold ? 1 : !a.sold && b.sold ? -1 : 0);
      const sold = sorted.filter(p => p.sold);
      const active = sorted.filter(p => !p.sold);

      // Calculate grade
      const grade = getExchangeGrade();

      return `
        <div class="p-3 space-y-3">
          <!-- Currency Tabs -->
          <div class="bg-white rounded-2xl shadow-lg p-2 flex gap-2">
            <button onclick="setExchangeTab('USD')" class="flex-1 py-3 rounded-xl font-bold transition ${state.exchangeTab === 'USD' ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white' : 'bg-gray-100 text-gray-600'}">ğŸ‡ºğŸ‡¸ USD</button>
            <button onclick="setExchangeTab('JPY')" class="flex-1 py-3 rounded-xl font-bold transition ${state.exchangeTab === 'JPY' ? 'bg-gradient-to-r from-red-500 to-pink-500 text-white' : 'bg-gray-100 text-gray-600'}">ğŸ‡¯ğŸ‡µ JPY</button>
          </div>

          <!-- Current Rate -->
          <div class="bg-white rounded-2xl shadow-lg p-4">
            <div class="flex flex-col items-center gap-2">
              <div class="text-sm text-gray-500 mb-1">${state.exchangeTab === 'USD' ? '1ë‹¬ëŸ¬ë‹¹' : '100ì—”ë‹¹'}</div>
              <div class="flex items-center gap-3 bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 rounded-xl border-2 border-blue-200">
                <i data-lucide="trending-up" class="w-8 h-8 text-blue-600"></i>
                <span class="text-4xl font-bold text-blue-600" id="currentRateDisplay">${currentRate.toFixed(2)}</span>
                <span class="text-2xl font-bold text-gray-600">ì›</span>
                <button onclick="editExchangeRate()" class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-100 rounded-lg transition">
                  <i data-lucide="edit-2" class="w-6 h-6"></i>
                </button>
                <button onclick="fetchExchangeRate()" class="text-green-600 hover:text-green-800 p-2 hover:bg-green-100 rounded-lg transition" id="refreshRateBtn">
                  <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                </button>
              </div>
              <p class="text-sm text-gray-500" id="rateUpdateTime"></p>
            </div>
          </div>

          <!-- Portfolio Summary -->
          <div class="bg-white rounded-2xl shadow-lg p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <i data-lucide="dollar-sign" class="w-7 h-7 text-green-600"></i>
                <div>
                  <h1 class="text-lg font-bold text-gray-800">${state.exchangeTab} ë¶„í• ë§¤ìˆ˜</h1>
                  <p class="text-xs text-gray-500">íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤</p>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-2">
              <div class="bg-blue-50 rounded-lg p-2.5">
                <p class="text-xs text-gray-600 mb-1">ì´ˆê¸°ì˜ˆì‚°</p>
                <p class="font-bold text-sm text-blue-600">${(initialBudget / 10000).toFixed(0)}ë§Œì›</p>
              </div>
              <div class="bg-purple-50 rounded-lg p-2.5">
                <p class="text-xs text-gray-600 mb-1">í˜„ì¬ì˜ˆì‚°</p>
                <p class="font-bold text-sm text-purple-600">${((initialBudget + profit) / 10000).toFixed(0)}ë§Œì›</p>
              </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
              <div class="bg-indigo-50 rounded-lg p-2.5">
                <p class="text-xs text-gray-600 mb-1">ëˆ„ì íˆ¬ì</p>
                <p class="font-bold text-sm text-indigo-600">${(cumInvested / 10000).toFixed(0)}ë§Œì›</p>
              </div>
              <div class="bg-green-50 rounded-lg p-2.5">
                <p class="text-xs text-gray-600 mb-1">ëˆ„ì ë‹¬ëŸ¬</p>
                <p class="font-bold text-sm text-green-600">$${totalUsd.toFixed(2)}</p>
              </div>
              <div class="bg-red-50 rounded-lg p-2.5">
                <p class="text-xs text-gray-600 mb-1">ëˆ„ì ì—”í™”</p>
                <p class="font-bold text-sm text-red-600">Â¥${totalJpy.toFixed(0)}</p>
              </div>
            </div>
          </div>

          <!-- Grade Card -->
          <div class="${grade.bg} rounded-xl shadow-lg p-4">
            <div class="flex flex-col items-center">
              <div class="flex items-center justify-center gap-2 mb-3">
                <i data-lucide="trophy" class="w-6 h-6 ${grade.color}"></i>
                <h3 class="text-xl font-bold ${grade.color}">íˆ¬ì ë“±ê¸‰: ${grade.grade}</h3>
              </div>
              <div class="w-full bg-white bg-opacity-50 rounded-lg p-3">
                <div class="text-center">
                  <p class="text-xs text-gray-600 mb-1">ëˆ„ì  ì‹¤í˜„ìˆ˜ìµ (ë§¤ë„ì™„ë£Œ)</p>
                  <p class="text-2xl font-bold ${grade.totalProfit >= 0 ? 'text-red-600' : 'text-blue-600'}">
                    ${grade.totalProfit >= 0 ? '+' : ''}${Math.round(grade.totalProfit).toLocaleString()}ì›
                  </p>
                  <p class="text-sm font-semibold mt-1 ${grade.totalProfit >= 0 ? 'text-red-500' : 'text-blue-500'}">
                    ${grade.totalProfit >= 0 ? '+' : ''}${grade.returnRate.toFixed(2)}%
                  </p>
                </div>
              </div>
            </div>
          </div>



          <!-- Investment Status -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-bold text-gray-800 mb-3 text-sm">ğŸ“Š íˆ¬ì í˜„í™©</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-blue-50 rounded p-3">
                <p class="text-xs text-gray-600 mb-1">ì´ íˆ¬ìê¸ˆ</p>
                <p class="font-bold text-blue-600">${(invested / 10000).toFixed(0)}ë§Œì›</p>
              </div>
              <div class="bg-green-50 rounded p-3">
                <p class="text-xs text-gray-600 mb-1">ë³´ìœ  ${state.exchangeTab}</p>
                <p class="font-bold text-green-600">${sym}${state.exchangeTab === 'USD' ? foreign.toFixed(2) : foreign.toFixed(0)}</p>
              </div>
              <div class="bg-purple-50 rounded p-3">
                <p class="text-xs text-gray-600 mb-1">í‰ê·  ë§¤ìˆ˜ê°€</p>
                <p class="font-bold text-purple-600">${avgRate}ì›</p>
              </div>
              <div class="bg-orange-50 rounded p-3">
                <p class="text-xs text-gray-600 mb-1">í‰ê°€ì†ìµ</p>
                <p class="font-bold ${unrealized >= 0 ? 'text-red-600' : 'text-blue-600'}">${unrealized >= 0 ? '+' : ''}${(unrealized / 10000).toFixed(1)}ë§Œì›</p>
              </div>
            </div>
          </div>

          <!-- Stats Button -->
          <button onclick="toggleExchangeStats()" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">
            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
            ${state.showExchangeStats ? 'í†µê³„ ìˆ¨ê¸°ê¸°' : 'ê¸°ê°„ë³„ í†µê³„ ë³´ê¸°'}
          </button>

          <!-- Stats Section -->
          ${state.showExchangeStats ? renderExchangeStats() : ''}

          <!-- Add Phase Button -->
          <button onclick="addExchangePhase()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg">
            <i data-lucide="plus" class="w-5 h-5"></i>
            ìƒˆ ë§¤ìˆ˜ ì¶”ê°€
          </button>

          <!-- Active Phases -->
          ${active.map((p, i) => renderExchangePhase(p, i, currentRate, sym)).join('')}

          <!-- Sold Phases -->
          ${sold.length > 0 ? `
            <div class="mt-4">
              <h3 class="font-bold text-gray-700 mb-3 text-sm">âœ… ë§¤ë„ ì™„ë£Œ (${sold.length}ê±´)</h3>
              ${sold.slice(0, state.soldItemsVisible).map(p => renderSoldPhase(p)).join('')}
              ${sold.length > state.soldItemsVisible ? `
                <button onclick="loadMoreSoldItems()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-medium mt-2">
                  ë”ë³´ê¸° (${sold.length - state.soldItemsVisible}ê±´)
                </button>
              ` : ''}
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderExchangeStats() {
      const phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      let sold = phases.filter(p => p.sold && p.sellDate);
      
      if (state.exchangeStatsStartDate || state.exchangeStatsEndDate) {
        sold = sold.filter(p => {
          const sellDate = new Date(p.sellDate);
          const start = state.exchangeStatsStartDate ? new Date(state.exchangeStatsStartDate) : new Date('1900-01-01');
          const end = state.exchangeStatsEndDate ? new Date(state.exchangeStatsEndDate) : new Date('2100-12-31');
          return sellDate >= start && sellDate <= end;
        });
      }

      const stats = [];
      if (sold.length > 0) {
        const grouped = {};
        sold.forEach(p => {
          const d = new Date(p.sellDate);
          let key;
          if (state.exchangeStatsPeriod === 'daily') key = p.sellDate;
          else if (state.exchangeStatsPeriod === 'weekly') key = `${d.getFullYear()}-W${Math.ceil(((d - new Date(d.getFullYear(), 0, 1)) / 86400000 + new Date(d.getFullYear(), 0, 1).getDay() + 1) / 7)}`;
          else if (state.exchangeStatsPeriod === 'monthly') key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          else key = `${d.getFullYear()}`;
          
          if (!grouped[key]) grouped[key] = { period: key, count: 0, inv: 0, prof: 0 };
          const f = p.amount / p.buyRate;
          grouped[key].count += 1;
          grouped[key].inv += p.amount;
          grouped[key].prof += f * p.sellRate - p.amount;
        });
        
        const sorted = Object.values(grouped).sort((a, b) => a.period.localeCompare(b.period));
        let cumInv = 0, cumProf = 0;
        sorted.forEach(item => {
          cumInv += item.inv;
          cumProf += item.prof;
          stats.push({
            ...item,
            rate: ((item.prof / item.inv) * 100).toFixed(2),
            cumInv,
            cumProf,
            cumRate: ((cumProf / cumInv) * 100).toFixed(2)
          });
        });
        stats.reverse();
      }

      return `
        <div class="bg-white rounded-xl shadow-lg p-4">
          <div class="mb-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-bold text-gray-800 text-sm">ğŸ“Š ê¸°ê°„ë³„ íˆ¬ì í†µê³„</h3>
              <div class="flex gap-1">
                ${['daily', 'weekly', 'monthly', 'yearly'].map(p => `
                  <button onclick="setExchangeStatsPeriod('${p}')" class="px-2 py-1 rounded text-xs ${state.exchangeStatsPeriod === p ? 'bg-emerald-500 text-white' : 'bg-gray-200 text-gray-700'}">
                    ${p === 'daily' ? 'ì¼' : p === 'weekly' ? 'ì£¼' : p === 'monthly' ? 'ì›”' : 'ë…„'}
                  </button>
                `).join('')}
              </div>
            </div>
            
            <div class="mb-3 p-3 bg-gray-50 rounded-lg">
              <p class="text-xs font-semibold text-gray-700 mb-2">ğŸ“… ê¸°ê°„ ê²€ìƒ‰</p>
              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs text-gray-600 block mb-1">ì‹œì‘ì¼</label>
                  <input type="date" id="exchangeStatsStart" value="${state.exchangeStatsStartDate}" onchange="updateExchangeStatsDate('start', this.value)" class="w-full px-2 py-1 border rounded text-xs">
                </div>
                <div>
                  <label class="text-xs text-gray-600 block mb-1">ì¢…ë£Œì¼</label>
                  <input type="date" id="exchangeStatsEnd" value="${state.exchangeStatsEndDate}" onchange="updateExchangeStatsDate('end', this.value)" class="w-full px-2 py-1 border rounded text-xs">
                </div>
              </div>
              ${(state.exchangeStatsStartDate || state.exchangeStatsEndDate) ? `
                <button onclick="clearExchangeStatsDate()" class="mt-2 w-full bg-gray-300 text-gray-700 py-1 rounded text-xs font-medium">
                  ê¸°ê°„ ì´ˆê¸°í™”
                </button>
              ` : ''}
            </div>
          </div>
          
          ${stats.length > 0 ? `
            <div class="space-y-3">
              ${stats.map(s => `
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3 border">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <p class="font-bold text-sm">${s.period}</p>
                      <p class="text-xs text-gray-600">ë§¤ë„ ${s.count}ê±´</p>
                    </div>
                    <div class="px-2 py-1 rounded-lg ${parseFloat(s.rate) >= 0 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                      <p class="text-xs font-bold">${parseFloat(s.rate) >= 0 ? '+' : ''}${s.rate}%</p>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="bg-white rounded p-2">
                      <p class="text-xs text-gray-600">íˆ¬ìê¸ˆ</p>
                      <p class="font-bold text-sm text-blue-600">${(s.inv / 10000).toFixed(0)}ë§Œ</p>
                    </div>
                    <div class="bg-white rounded p-2">
                      <p class="text-xs text-gray-600">ì‹¤í˜„ìˆ˜ìµ</p>
                      <p class="font-bold text-sm ${s.prof >= 0 ? 'text-red-600' : 'text-blue-600'}">${s.prof >= 0 ? '+' : ''}${(s.prof / 10000).toFixed(1)}ë§Œ</p>
                    </div>
                  </div>
                  <div class="border-t pt-2">
                    <p class="text-xs font-semibold text-gray-700 mb-1">ëˆ„ì  í˜„í™©</p>
                    <div class="grid grid-cols-3 gap-2">
                      <div class="bg-indigo-50 rounded p-1.5">
                        <p class="text-xs text-gray-600">ëˆ„ì íˆ¬ì</p>
                        <p class="font-bold text-xs text-indigo-600">${(s.cumInv / 10000).toFixed(0)}ë§Œ</p>
                      </div>
                      <div class="bg-pink-50 rounded p-1.5">
                        <p class="text-xs text-gray-600">ëˆ„ì ìˆ˜ìµ</p>
                        <p class="font-bold text-xs ${s.cumProf >= 0 ? 'text-pink-600' : 'text-blue-600'}">${s.cumProf >= 0 ? '+' : ''}${(s.cumProf / 10000).toFixed(1)}ë§Œ</p>
                      </div>
                      <div class="bg-amber-50 rounded p-1.5">
                        <p class="text-xs text-gray-600">ëˆ„ì ë¥ </p>
                        <p class="font-bold text-xs ${s.cumProf >= 0 ? 'text-amber-600' : 'text-blue-600'}">${parseFloat(s.cumRate) >= 0 ? '+' : ''}${s.cumRate}%</p>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div class="text-center py-8">
              <p class="text-sm text-gray-500">ì„ íƒí•œ ê¸°ê°„ì— ë§¤ë„ ì™„ë£Œëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
          `}
        </div>
      `;
    }

    function renderExchangePhase(p, i, currentRate, sym) {
      const f = p.amount / p.buyRate;
      const diff = currentRate - p.buyRate;
      const cp = (f * currentRate) - p.amount;
      const targetReached = p.completed && currentRate >= p.sellRate;
      const isExpanded = state.expandedPhase === p.id;

      return `
        <div class="bg-white rounded-xl shadow-md ${targetReached ? 'animate-pulse ring-4 ring-yellow-400' : ''}">
          <div onclick="toggleExpandPhase(${p.id})" class="p-4 cursor-pointer ${p.completed ? 'bg-green-50 rounded-t-xl' : 'bg-blue-50 rounded-t-xl'}">
            <div class="flex justify-between items-start">
              <div class="flex items-start gap-3 flex-1">
                ${p.completed ? '<i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>' : '<i data-lucide="shopping-cart" class="w-6 h-6 text-blue-500"></i>'}
                <div class="flex-1">
                  <p class="font-bold text-gray-800">${i + 1}ì°¨ ë§¤ìˆ˜</p>
                  <p class="text-xs text-gray-600 mt-0.5">${p.completed ? `ë§¤ìˆ˜ì¼: ${p.date}` : 'ë§¤ìˆ˜ëŒ€ê¸°'}</p>
                  ${p.completed ? `
                    <div class="mt-2 space-y-1">
                      <p class="text-xs font-bold ${diff >= 0 ? 'text-red-600' : 'text-blue-600'}">í™˜ìœ¨ì°¨: ${diff >= 0 ? '+' : ''}${diff.toFixed(state.exchangeTab === 'USD' ? 1 : 2)}ì›</p>
                      <p class="text-xs font-bold ${cp >= 0 ? 'text-red-600' : 'text-blue-600'}">í˜„ì¬: ${cp >= 0 ? '+' : ''}${(cp / 10000).toFixed(1)}ë§Œì›</p>
                      ${targetReached ? '<p class="text-xs font-bold text-yellow-600 animate-pulse">ğŸ¯ ëª©í‘œë„ë‹¬!</p>' : ''}
                    </div>
                  ` : ''}
                </div>
              </div>
              ${isExpanded ? '<i data-lucide="chevron-up" class="w-5 h-5"></i>' : '<i data-lucide="chevron-down" class="w-5 h-5"></i>'}
            </div>
          </div>
          ${isExpanded ? `
            <div class="p-4 space-y-3">
              <div>
                <label class="text-xs text-gray-600 block mb-1 font-semibold">íˆ¬ìê¸ˆì•¡ (KRW)</label>
                <input type="number" id="phase-amount-${p.id}" value="${p.amount}" class="w-full px-3 py-2 border rounded" ${p.completed ? 'disabled' : ''}>
              </div>
              <div>
                <label class="text-xs text-gray-600 block mb-1 font-semibold">ë§¤ìˆ˜í™˜ìœ¨</label>
                <input type="number" id="phase-buyRate-${p.id}" value="${p.buyRate}" class="w-full px-3 py-2 border rounded" ${p.completed ? 'disabled' : ''} step="0.01">
              </div>
              <div>
                <label class="text-xs text-gray-600 block mb-1 font-semibold">ëª©í‘œ ë§¤ë„í™˜ìœ¨</label>
                <input type="number" id="phase-sellRate-${p.id}" value="${p.sellRate}" class="w-full px-3 py-2 border rounded" step="0.01">
              </div>
              <div class="bg-gray-50 rounded p-3 text-sm space-y-1">
                <p>ğŸ’µ ${sym}${state.exchangeTab === 'USD' ? f.toFixed(2) : f.toFixed(0)}</p>
                <p>ğŸ“ˆ ì§€ê¸ˆ ë§¤ë„ì‹œ: ${cp >= 0 ? '+' : ''}${cp.toLocaleString()}ì›</p>
              </div>
              <div class="flex gap-2">
                ${!p.completed ? `<button onclick="completeExchangePhase(${p.id})" class="flex-1 bg-green-500 text-white py-2 rounded font-bold">ë§¤ìˆ˜ì™„ë£Œ</button>` : ''}
                ${p.completed ? `<button onclick="sellExchangePhase(${p.id})" class="flex-1 bg-purple-500 text-white py-2 rounded font-bold text-sm">ë§¤ë„ (${cp >= 0 ? '+' : ''}${(cp / 10000).toFixed(1)}ë§Œ)</button>` : ''}
                <button onclick="saveExchangePhase(${p.id})" class="px-4 bg-blue-500 text-white rounded font-bold">ì €ì¥</button>
                <button onclick="deleteExchangePhase(${p.id})" class="px-4 bg-red-500 text-white rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderSoldPhase(p) {
      const f = p.amount / p.buyRate;
      const pr = (f * p.sellRate) - p.amount;
      const isExpanded = state.expandedPhase === p.id;

      return `
        <div class="bg-white rounded-xl shadow-md mb-3 opacity-70">
          <div onclick="toggleExpandPhase(${p.id})" class="bg-gray-100 p-4 cursor-pointer rounded-t-xl">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-bold text-gray-800">ë§¤ë„ì™„ë£Œ ${p.id}ì°¨</p>
                <p class="text-xs text-gray-600">ë§¤ë„ì¼: ${p.sellDate}</p>
                <p class="text-sm font-bold mt-1 ${pr >= 0 ? 'text-red-600' : 'text-blue-600'}">
                  ì‹¤í˜„: ${pr >= 0 ? '+' : ''}${(pr / 10000).toFixed(1)}ë§Œì› (${((pr / p.amount) * 100).toFixed(2)}%)
                </p>
              </div>
              ${isExpanded ? '<i data-lucide="chevron-up" class="w-5 h-5"></i>' : '<i data-lucide="chevron-down" class="w-5 h-5"></i>'}
            </div>
          </div>
          ${isExpanded ? `
            <div class="p-4 bg-gray-50 space-y-3 rounded-b-xl">
              <input type="number" id="sold-amount-${p.id}" value="${p.amount}" onchange="updateSoldPhase(${p.id}, 'amount', this.value)" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ìˆ˜ê¸ˆì•¡">
              <input type="number" id="sold-buyRate-${p.id}" value="${p.buyRate}" onchange="updateSoldPhase(${p.id}, 'buyRate', this.value)" class="w-full px-3 py-2 border rounded" step="0.01" placeholder="ë§¤ìˆ˜í™˜ìœ¨">
              <input type="number" id="sold-sellRate-${p.id}" value="${p.sellRate}" onchange="updateSoldPhase(${p.id}, 'sellRate', this.value)" class="w-full px-3 py-2 border rounded" step="0.01" placeholder="ë§¤ë„í™˜ìœ¨">
              <input type="date" id="sold-date-${p.id}" value="${p.date}" onchange="updateSoldPhase(${p.id}, 'date', this.value)" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ìˆ˜ì¼">
              <input type="date" id="sold-sellDate-${p.id}" value="${p.sellDate}" onchange="updateSoldPhase(${p.id}, 'sellDate', this.value)" class="w-full px-3 py-2 border rounded" placeholder="ë§¤ë„ì¼">
              <button onclick="deleteExchangePhase(${p.id})" class="w-full bg-red-500 text-white py-2 rounded flex items-center justify-center gap-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                ì‚­ì œ
              </button>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Exchange helper functions
    function getExchangeGrade() {
      const year = new Date().getFullYear();
      const allSold = [...state.usdPhases, ...state.jpyPhases].filter(p => p.sold && p.sellDate && new Date(p.sellDate).getFullYear() === year);
      const totalInv = allSold.reduce((s, p) => s + p.amount, 0);
      const totalProf = allSold.reduce((s, p) => s + ((p.amount / p.buyRate) * p.sellRate - p.amount), 0);
      const rate = totalInv > 0 ? (totalProf / totalInv) * 100 : 0;
      
      let gradeInfo = { grade: 'ì´ˆë³´', color: 'text-gray-600', bg: 'bg-gray-100' };
      if (allSold.length > 0) {
        if (rate < 0) gradeInfo = { grade: 'ì†ì‹¤', color: 'text-gray-700', bg: 'bg-gray-200' };
        else if (rate < 10) gradeInfo = { grade: 'í•˜ìˆ˜', color: 'text-blue-700', bg: 'bg-blue-100' };
        else if (rate < 20) gradeInfo = { grade: 'ì¤‘ìˆ˜', color: 'text-green-700', bg: 'bg-green-100' };
        else if (rate < 30) gradeInfo = { grade: 'ê³ ìˆ˜', color: 'text-purple-700', bg: 'bg-purple-100' };
        else if (rate < 50) gradeInfo = { grade: 'ì‹¤ë²„', color: 'text-slate-700', bg: 'bg-slate-200' };
        else if (rate < 60) gradeInfo = { grade: 'ê³¨ë“œ', color: 'text-yellow-700', bg: 'bg-yellow-100' };
        else gradeInfo = { grade: 'íˆ¬ìì˜ ì‹ ', color: 'text-red-700', bg: 'bg-gradient-to-r from-yellow-200 to-red-200' };
      }
      
      return { ...gradeInfo, totalProfit: totalProf, totalInvested: totalInv, returnRate: rate };
    }

    function setExchangeTab(tab) {
      state.exchangeTab = tab;
      render();
    }

    function editExchangeRate() {
      const currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      const newRate = prompt('í™˜ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”:', currentRate);
      if (newRate === null) return;
      
      const rate = parseFloat(newRate);
      if (isNaN(rate) || rate <= 0) {
        alert('ì˜¬ë°”ë¥¸ í™˜ìœ¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      
      if (state.exchangeTab === 'USD') state.usdRate = rate;
      else state.jpyRate = rate;
      
      saveData();
      render();
      showToast('í™˜ìœ¨ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    async function fetchExchangeRate() {
      const btn = document.getElementById('refreshRateBtn');
      if (btn) btn.classList.add('animate-spin');
      
      try {
        const res = await fetch('https://api.exchangerate-api.com/v4/latest/KRW');
        const data = await res.json();
        if (data.rates.USD && data.rates.JPY) {
          state.usdRate = Math.round((1 / data.rates.USD) * 10) / 10;
          state.jpyRate = Math.round((100 / data.rates.JPY) * 100) / 100;
          saveData();
          render();
          showToast('í™˜ìœ¨ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
      } catch (e) {
        console.error(e);
        showToast('í™˜ìœ¨ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
      }
      
      if (btn) btn.classList.remove('animate-spin');
    }



    function toggleExchangeStats() {
      state.showExchangeStats = !state.showExchangeStats;
      render();
    }

    function setExchangeStatsPeriod(period) {
      state.exchangeStatsPeriod = period;
      render();
    }

    function updateExchangeStatsDate(type, value) {
      if (type === 'start') state.exchangeStatsStartDate = value;
      else state.exchangeStatsEndDate = value;
      render();
    }

    function clearExchangeStatsDate() {
      state.exchangeStatsStartDate = '';
      state.exchangeStatsEndDate = '';
      render();
    }

    function addExchangePhase() {
      const currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      const newPhase = {
        id: state.exchangeTab === 'USD' ? state.usdNextId : state.jpyNextId,
        amount: 1000000,
        buyRate: currentRate,
        sellRate: currentRate + 1.5,
        completed: false,
        sold: false,
        date: '',
        sellDate: ''
      };
      
      if (state.exchangeTab === 'USD') {
        state.usdPhases.push(newPhase);
        state.usdNextId++;
      } else {
        state.jpyPhases.push(newPhase);
        state.jpyNextId++;
      }
      
      state.expandedPhase = newPhase.id;
      saveData();
      render();
      showToast('ìƒˆ ë§¤ìˆ˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function toggleExpandPhase(id) {
      state.expandedPhase = state.expandedPhase === id ? null : id;
      render();
    }

    function saveExchangePhase(id) {
      const phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      const phase = phases.find(p => p.id === id);
      if (!phase) return;
      
      const amount = parseFloat(document.getElementById(`phase-amount-${id}`)?.value) || phase.amount;
      const buyRate = parseFloat(document.getElementById(`phase-buyRate-${id}`)?.value) || phase.buyRate;
      const sellRate = parseFloat(document.getElementById(`phase-sellRate-${id}`)?.value) || phase.sellRate;
      
      phase.amount = amount;
      phase.buyRate = buyRate;
      phase.sellRate = sellRate;
      
      saveData();
      render();
      showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function completeExchangePhase(id) {
      const phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      const phase = phases.find(p => p.id === id);
      if (!phase) return;
      
      // Save current values first
      saveExchangePhase(id);
      
      phase.completed = true;
      phase.date = new Date().toISOString().split('T')[0];
      
      saveData();
      render();
      showToast('ë§¤ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function sellExchangePhase(id) {
      const phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      const phase = phases.find(p => p.id === id);
      if (!phase) return;
      
      if (!phase.completed) {
        alert('ë§¤ìˆ˜ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”!');
        return;
      }
      
      const currentRate = state.exchangeTab === 'USD' ? state.usdRate : state.jpyRate;
      phase.sold = true;
      phase.sellDate = new Date().toISOString().split('T')[0];
      phase.sellRate = currentRate;
      
      saveData();
      render();
      showToast('ë§¤ë„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteExchangePhase(id) {
      if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      if (state.exchangeTab === 'USD') {
        state.usdPhases = state.usdPhases.filter(p => p.id !== id);
      } else {
        state.jpyPhases = state.jpyPhases.filter(p => p.id !== id);
      }
      
      saveData();
      render();
      showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function updateSoldPhase(id, field, value) {
      const phases = state.exchangeTab === 'USD' ? state.usdPhases : state.jpyPhases;
      const phase = phases.find(p => p.id === id);
      if (!phase) return;
      
      if (field === 'amount' || field === 'buyRate' || field === 'sellRate') {
        phase[field] = parseFloat(value) || 0;
      } else {
        phase[field] = value;
      }
      
      saveData();
      render();
    }

    function loadMoreSoldItems() {
      state.soldItemsVisible += 10;
      render();
    }

    function renderAddInvestmentModal() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddInvestment=false;render();}">
          <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-4 border-b sticky top-0 bg-white rounded-t-xl">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">ğŸ“ˆ íˆ¬ì ì¢…ëª© ì¶”ê°€</h2>
                <button onclick="state.showAddInvestment=false;render()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
              </div>
            </div>
            <div class="p-4 space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">ì¢…ëª©ëª…</label>
                <input type="text" id="invName" class="w-full p-2 border rounded-lg" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">íˆ¬ì ìœ í˜•</label>
                <select id="invType" class="w-full p-2 border rounded-lg">
                  <option value="stock">ì£¼ì‹</option>
                  <option value="etf">ETF</option>
                  <option value="fund">í€ë“œ</option>
                  <option value="crypto">ì•”í˜¸í™”í</option>
                  <option value="gold">ê¸ˆ</option>
                  <option value="realestate">ë¶€ë™ì‚°</option>
                  <option value="bond">ì±„ê¶Œ</option>
                  <option value="other">ê¸°íƒ€</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">ë³´ìœ  ìˆ˜ëŸ‰</label>
                <input type="number" id="invQuantity" class="w-full p-2 border rounded-lg" placeholder="0">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">ë§¤ì…ê°€ (1ì£¼ë‹¹)</label>
                <div class="relative">
                  <input type="number" id="invBuyPrice" class="w-full p-2 pr-10 border rounded-lg" placeholder="0">
                  <span class="absolute right-3 top-2.5 text-gray-500 text-sm">ì›</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">í˜„ì¬ê°€ (1ì£¼ë‹¹)</label>
                <div class="relative">
                  <input type="number" id="invCurrentPrice" class="w-full p-2 pr-10 border rounded-lg" placeholder="ë§¤ì…ê°€ì™€ ë™ì¼ì‹œ ë¹„ì›Œë‘ì„¸ìš”">
                  <span class="absolute right-3 top-2.5 text-gray-500 text-sm">ì›</span>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">ë§¤ì…ì¼</label>
                <input type="date" id="invBuyDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg">
              </div>
              <div class="flex gap-2 pt-4">
                <button onclick="addInvestment()" class="flex-1 bg-indigo-500 text-white py-3 rounded-lg font-medium shadow-md hover:bg-indigo-600 transition">ì¶”ê°€</button>
                <button onclick="state.showAddInvestment=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium hover:bg-gray-400 transition">ì·¨ì†Œ</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderAddTransactionModal() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showAddTransaction=false;render();}">
          <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-4 border-b sticky top-0 bg-white rounded-t-xl">
              <h2 class="text-xl font-bold">ê±°ë˜ ì¶”ê°€</h2>
            </div>
            <div class="p-4 space-y-4">
              <div class="flex gap-2">
                <button id="btn-expense" onclick="setTxType('expense')" class="flex-1 py-2 rounded-lg transition bg-red-500 text-white shadow-md">ì§€ì¶œ</button>
                <button id="btn-income" onclick="setTxType('income')" class="flex-1 py-2 rounded-lg transition bg-gray-200">ìˆ˜ì…</button>
              </div>
              <input type="hidden" id="txType" value="expense">
              <div><label class="block text-sm font-medium mb-1">ë‚ ì§œ</label><input type="date" id="txDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-2 border rounded-lg"></div>
              <div><label class="block text-sm font-medium mb-1">ê¸ˆì•¡</label><input type="number" id="txAmount" class="w-full p-2 border rounded-lg" placeholder="ê¸ˆì•¡ ì…ë ¥"></div>
              <div id="expense-options">
                <div><label class="block text-sm font-medium mb-1">ê²°ì œìˆ˜ë‹¨</label>
                  <select id="txPayment" onchange="toggleInstallment()" class="w-full p-2 border rounded-lg"><option value="card">ì¹´ë“œ</option><option value="cash">í˜„ê¸ˆ</option></select>
                </div>
                <div id="installment-div" class="mt-4"><label class="block text-sm font-medium mb-1">í• ë¶€</label>
                  <select id="txInstallment" class="w-full p-2 border rounded-lg"><option value="0">ì¼ì‹œë¶ˆ</option>${[2,3,4,5,6,7,8,9,10,11,12,15,18,20,24,30,36].map(m => `<option value="${m}">${m}ê°œì›”</option>`).join('')}</select>
                </div>
                <div class="mt-4"><label class="block text-sm font-medium mb-1">ì§€ì¶œ ìœ í˜•</label>
                  <div class="flex gap-2">
                    <button id="btn-necessary" onclick="setNecessary(true)" class="flex-1 py-2 rounded-lg transition bg-blue-500 text-white shadow-md">í•„ìš”ì§€ì¶œ</button>
                    <button id="btn-unnecessary" onclick="setNecessary(false)" class="flex-1 py-2 rounded-lg transition bg-gray-200">ë¶ˆí•„ìš”ì§€ì¶œ</button>
                  </div>
                  <input type="hidden" id="txNecessary" value="true">
                </div>
              </div>
              <div><label class="block text-sm font-medium mb-1">ì¹´í…Œê³ ë¦¬</label>
                <select id="txCategory" class="w-full p-2 border rounded-lg"><option value="">ì„ íƒí•˜ì„¸ìš”</option>${state.categories.expense.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
              </div>
              <div><label class="block text-sm font-medium mb-1">ë©”ëª¨</label><textarea id="txMemo" class="w-full p-2 border rounded-lg" rows="3" placeholder="ë©”ëª¨ ì…ë ¥"></textarea></div>
              <div class="flex gap-2 pt-4">
                <button onclick="submitTransaction()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-medium shadow-md hover:bg-blue-600 transition">ì €ì¥</button>
                <button onclick="state.showAddTransaction=false;render()" class="flex-1 bg-gray-300 py-3 rounded-lg font-medium hover:bg-gray-400 transition">ì·¨ì†Œ</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    let currentTxType = 'expense';
    let isNecessary = true;

    function setTxType(type) {
      currentTxType = type;
      document.getElementById('txType').value = type;
      document.getElementById('btn-expense').className = type === 'expense' ? 'flex-1 py-2 rounded-lg transition bg-red-500 text-white shadow-md' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      document.getElementById('btn-income').className = type === 'income' ? 'flex-1 py-2 rounded-lg transition bg-green-500 text-white shadow-md' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      document.getElementById('expense-options').style.display = type === 'expense' ? 'block' : 'none';
      
      const catSelect = document.getElementById('txCategory');
      catSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + state.categories[type].map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function setNecessary(val) {
      isNecessary = val;
      document.getElementById('txNecessary').value = val;
      document.getElementById('btn-necessary').className = val ? 'flex-1 py-2 rounded-lg transition bg-blue-500 text-white shadow-md' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      document.getElementById('btn-unnecessary').className = !val ? 'flex-1 py-2 rounded-lg transition bg-gray-500 text-white shadow-md' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
    }

    function toggleInstallment() {
      const payment = document.getElementById('txPayment').value;
      document.getElementById('installment-div').style.display = payment === 'card' ? 'block' : 'none';
    }

    function submitTransaction() {
      const type = document.getElementById('txType').value;
      const date = document.getElementById('txDate').value;
      const amount = Number(document.getElementById('txAmount').value);
      const category = document.getElementById('txCategory').value;
      const memo = document.getElementById('txMemo').value;
      
      if (!category) { alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'); return; }
      if (!amount || amount <= 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      if (amount > 1000000000) { alert('ê¸ˆì•¡ì´ ë„ˆë¬´ í½ë‹ˆë‹¤'); return; }

      const tx = {
        id: Date.now(),
        type,
        date,
        amount,
        category,
        memo,
        paymentMethod: type === 'expense' ? document.getElementById('txPayment').value : 'cash',
        installment: type === 'expense' && document.getElementById('txPayment').value === 'card' ? Number(document.getElementById('txInstallment').value) : 0,
        isNecessary: type === 'expense' ? document.getElementById('txNecessary').value === 'true' : true
      };

      state.transactions.push(tx);
      state.showAddTransaction = false;
      saveData();
      render();
      showToast('ê±°ë˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function renderCompoundCalc() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showCompoundCalc=false;render();}">
          <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-4 border-b sticky top-0 bg-white rounded-t-xl z-10">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">ğŸ’° ì ë¦½ì‹ ë³µë¦¬ê³„ì‚°ê¸°</h2>
                <button onclick="state.showCompoundCalc=false;render()" class="text-gray-500 hover:text-gray-700 text-2xl w-8 h-8 flex items-center justify-center">âœ•</button>
              </div>
            </div>
            <div class="p-4 space-y-4">
              <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl space-y-3">
                <div><label class="block text-sm font-medium mb-1">ì´ˆê¸° íˆ¬ìê¸ˆ</label><div class="relative"><input type="number" id="calcInitial" class="w-full p-3 pr-10 border rounded-lg" placeholder="0"><span class="absolute right-3 top-3.5 text-gray-500 text-sm">ì›</span></div></div>
                <div><label class="block text-sm font-medium mb-1">ì›” ì ë¦½ê¸ˆ</label><div class="relative"><input type="number" id="calcMonthly" class="w-full p-3 pr-10 border rounded-lg" placeholder="0"><span class="absolute right-3 top-3.5 text-gray-500 text-sm">ì›</span></div></div>
                <div><label class="block text-sm font-medium mb-1">íˆ¬ì ê¸°ê°„</label><div class="relative"><input type="number" id="calcYears" class="w-full p-3 pr-10 border rounded-lg" placeholder="0"><span class="absolute right-3 top-3.5 text-gray-500 text-sm">ë…„</span></div></div>
                <div><label class="block text-sm font-medium mb-1">ì—° ìˆ˜ìµë¥ </label><div class="relative"><input type="number" step="0.1" id="calcRate" class="w-full p-3 pr-10 border rounded-lg" placeholder="0"><span class="absolute right-3 top-3.5 text-gray-500 text-sm">%</span></div></div>
                <button onclick="calculateCompound()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-bold hover:from-blue-700 hover:to-purple-700 transition shadow-lg">ê³„ì‚°í•˜ê¸°</button>
              </div>
              <div id="calc-result"></div>
            </div>
          </div>
        </div>
      `;
    }

    function calculateCompound() {
      const initial = Number(document.getElementById('calcInitial').value) || 0;
      const monthly = Number(document.getElementById('calcMonthly').value) || 0;
      const years = Number(document.getElementById('calcYears').value) || 0;
      const rate = Number(document.getElementById('calcRate').value) / 100 || 0;

      if (years === 0) { alert('ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

      const yearlyData = [];
      let currentAmount = initial;

      for (let year = 1; year <= years; year++) {
        for (let month = 1; month <= 12; month++) {
          currentAmount += monthly;
          currentAmount = currentAmount * (1 + rate / 12);
        }
        const totalDeposit = initial + (monthly * 12 * year);
        yearlyData.push({ year, amount: Math.round(currentAmount), deposit: totalDeposit, interest: Math.round(currentAmount - totalDeposit) });
      }

      const finalAmount = Math.round(currentAmount);
      const totalDeposit = initial + (monthly * 12 * years);
      const totalInterest = finalAmount - totalDeposit;
      const maxAmount = Math.max(...yearlyData.map(d => d.amount));

      document.getElementById('calc-result').innerHTML = `
        <div class="bg-gradient-to-r from-purple-100 to-blue-100 p-5 rounded-xl shadow-lg">
          <h3 class="font-bold text-lg mb-4 text-center text-purple-700">ìµœì¢… ê²°ê³¼</h3>
          <div class="grid grid-cols-3 gap-3">
            <div class="bg-white p-4 rounded-lg text-center shadow"><div class="text-xs text-gray-600 mb-1">ìµœì¢… ê¸ˆì•¡</div><div class="text-lg font-bold text-purple-600">${formatNumber(finalAmount)}ì›</div></div>
            <div class="bg-white p-4 rounded-lg text-center shadow"><div class="text-xs text-gray-600 mb-1">ì´ ë‚©ì…ê¸ˆ</div><div class="text-lg font-bold text-blue-600">${formatNumber(totalDeposit)}ì›</div></div>
            <div class="bg-white p-4 rounded-lg text-center shadow"><div class="text-xs text-gray-600 mb-1">ì´ ì´ì</div><div class="text-lg font-bold text-green-600">${formatNumber(totalInterest)}ì›</div></div>
          </div>
        </div>
        <div class="bg-white rounded-xl border shadow-lg p-4 mt-4">
          <h3 class="font-bold mb-4">ğŸ“ˆ ë…„ë„ë³„ ê·¸ë˜í”„</h3>
          <div class="space-y-3">
            ${yearlyData.map(d => `
              <div class="space-y-1">
                <div class="flex justify-between text-sm"><span class="font-medium">${d.year}ë…„ì°¨</span><span class="font-bold text-purple-600">${formatNumber(d.amount)}ì›</span></div>
                <div class="relative w-full bg-gray-200 rounded-full h-7 overflow-hidden">
                  <div class="absolute left-0 top-0 h-7 bg-gradient-to-r from-blue-400 via-purple-500 to-purple-600 rounded-full flex items-center justify-end pr-2 transition-all" style="width: ${(d.amount / maxAmount) * 100}%">
                    <span class="text-xs text-white font-bold drop-shadow">${Math.round((d.amount / maxAmount) * 100)}%</span>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderSettings() {
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showSettings=false;render();}">
          <div class="bg-white rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-4 border-b sticky top-0 bg-white rounded-t-xl z-10">
              <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">âš™ï¸ ì„¤ì •</h2>
                <button onclick="state.showSettings=false;render()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
              </div>
            </div>
            <div class="p-4 space-y-6">
              <div class="bg-white rounded-xl border shadow-sm p-4">
                <h3 class="font-bold mb-4">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3>
                <div class="flex gap-2 mb-4">
                  <button id="cat-expense-btn" onclick="setCatType('expense')" class="flex-1 py-2 rounded-lg transition bg-red-500 text-white">ì§€ì¶œ</button>
                  <button id="cat-income-btn" onclick="setCatType('income')" class="flex-1 py-2 rounded-lg transition bg-gray-200">ìˆ˜ì…</button>
                </div>
                <div class="space-y-2 mb-4 max-h-48 overflow-y-auto" id="category-list"></div>
                <div class="flex gap-2">
                  <input type="text" id="newCatName" class="flex-1 p-2 border rounded-lg" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„">
                  <button onclick="addCategory()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">ì¶”ê°€</button>
                </div>
              </div>
              <div class="bg-white rounded-xl border shadow-sm p-4">
                <h3 class="font-bold mb-4">ë°ì´í„° ê´€ë¦¬</h3>
                <div class="space-y-3">
                  <button onclick="exportData()" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition flex items-center justify-center gap-2"><i data-lucide="download" class="w-5 h-5"></i>ë°ì´í„° ë°±ì—… (JSON)</button>
                  <button onclick="exportToCSV()" class="w-full bg-green-500 text-white py-3 rounded-lg font-medium hover:bg-green-600 transition flex items-center justify-center gap-2"><i data-lucide="download" class="w-5 h-5"></i>ê±°ë˜ë‚´ì—­ ë‚´ë³´ë‚´ê¸° (CSV)</button>
                  <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="hidden">
                  <button onclick="document.getElementById('importFile').click()" class="w-full bg-purple-500 text-white py-3 rounded-lg font-medium hover:bg-purple-600 transition flex items-center justify-center gap-2"><i data-lucide="upload" class="w-5 h-5"></i>ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSON)</button>
                  <button onclick="resetAllData()" class="w-full bg-red-500 text-white py-3 rounded-lg font-medium hover:bg-red-600 transition">ëª¨ë“  ë°ì´í„° ì‚­ì œ</button>
                </div>
              </div>
              <div class="bg-white rounded-xl border shadow-sm p-4">
                <h3 class="font-bold mb-2">ì•± ì •ë³´</h3>
                <div class="text-sm text-gray-600 space-y-1">
                  <p>ë²„ì „: 2.1</p>
                  <p>ì´ ê±°ë˜: ${state.transactions.length}ê±´</p>
                  <p>ì´ ë©”ëª¨: ${state.memos.length}ê°œ</p>
                  <p>ì´ í–‰ì‚¬: ${state.events.length}ê°œ</p>
                  <p>íˆ¬ì ì¢…ëª©: ${state.investments.length}ê°œ</p>
                  <p>ë°°ë‹¹ê¸ˆ ë‚´ì—­: ${state.dividends.length}ê±´</p>
                  <p>USD ê±°ë˜: ${state.usdPhases.length}ê±´</p>
                  <p>JPY ê±°ë˜: ${state.jpyPhases.length}ê±´</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    let currentCatType = 'expense';

    function setCatType(type) {
      currentCatType = type;
      document.getElementById('cat-expense-btn').className = type === 'expense' ? 'flex-1 py-2 rounded-lg transition bg-red-500 text-white' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      document.getElementById('cat-income-btn').className = type === 'income' ? 'flex-1 py-2 rounded-lg transition bg-green-500 text-white' : 'flex-1 py-2 rounded-lg transition bg-gray-200';
      updateCategoryList();
    }

    function updateCategoryList() {
      const listEl = document.getElementById('category-list');
      if (!listEl) return;
      listEl.innerHTML = state.categories[currentCatType].map((c, i) => `
        <div class="flex justify-between items-center p-2 border rounded bg-gray-50">
          <span>${c}</span>
          <button onclick="deleteCategory('${currentCatType}', ${i})" class="text-red-500 text-sm px-2">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    function addCategory() {
      const name = document.getElementById('newCatName')?.value?.trim();
      if (!name) { alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
      state.categories[currentCatType].push(name);
      saveData();
      document.getElementById('newCatName').value = '';
      updateCategoryList();
      showToast('ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    function deleteCategory(type, index) {
      if (confirm(`'${state.categories[type][index]}' ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        state.categories[type].splice(index, 1);
        saveData();
        updateCategoryList();
        showToast('ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function resetAllData() {
      if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?') && confirm('ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•©ë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
        state.transactions = [];
        state.memos = [];
        state.events = [];
        state.bankBalances = [];
        state.investments = [];
        state.dividends = [];
        state.goals = { year7: '', year5: '', year3: '', thisYear: '' };
        state.undoStack = [];
        state.usdPhases = [];
        state.jpyPhases = [];
        state.usdNextId = 1;
        state.jpyNextId = 1;
        saveData();
        state.showSettings = false;
        render();
        showToast('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function renderNavbar() {
      const tabs = [
        { id: 'home', icon: 'home', label: 'í™ˆ' },
        { id: 'history', icon: 'file-text', label: 'ë‚´ì—­' },
        { id: 'stats', icon: 'bar-chart-3', label: 'í†µê³„' },
        { id: 'add', icon: 'plus', label: '' },
        { id: 'goal', icon: 'target', label: 'ëª©í‘œ' },
        { id: 'invest', icon: 'trending-up', label: 'íˆ¬ì' },
        { id: 'exchange', icon: 'coins', label: 'í™˜ì „' }
      ];

      return `
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl max-w-md mx-auto">
          <div class="flex justify-around items-center p-2">
            ${tabs.map(t => t.id === 'add' ? `
              <button onclick="state.showAddTransaction=true;render()" class="flex flex-col items-center p-2 -mt-8">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full p-4 shadow-2xl hover:scale-110 transition transform">
                  <i data-lucide="plus" class="w-7 h-7" style="stroke-width: 3"></i>
                </div>
              </button>
            ` : `
              <button onclick="setActiveTab('${t.id}')" class="flex flex-col items-center p-2 rounded-lg transition ${state.activeTab === t.id ? 'text-blue-600 bg-blue-50' : 'text-gray-400'}">
                <i data-lucide="${t.icon}" class="w-5 h-5"></i>
                <span class="text-xs mt-1 font-medium">${t.label}</span>
              </button>
            `).join('')}
          </div>
        </div>
      `;
    }

    function setActiveTab(tab) {
      state.activeTab = tab;
      render();
    }

    function render() {
      const app = document.getElementById('app');
      
      if (state.isLoading) {
        app.innerHTML = `
          <div class="max-w-md mx-auto bg-gray-50 min-h-screen flex items-center justify-center">
            <div class="text-center">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <div class="text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
          </div>
        `;
        return;
      }

      let content = '';
      if (state.activeTab === 'home') content = renderHomeScreen();
      else if (state.activeTab === 'history') content = renderHistoryScreen();
      else if (state.activeTab === 'stats') content = renderStatsScreen();
      else if (state.activeTab === 'goal') content = renderGoalScreen();
      else if (state.activeTab === 'invest') content = renderInvestmentScreen();
      else if (state.activeTab === 'exchange') content = renderExchangeScreen();

      app.innerHTML = `
        ${renderHeader()}
        <div class="pb-4">${content}</div>
        ${renderNavbar()}
        ${state.showAddTransaction ? renderAddTransactionModal() : ''}
        ${state.showCompoundCalc ? renderCompoundCalc() : ''}
        ${state.showSettings ? renderSettings() : ''}
        ${state.showAddInvestment ? renderAddInvestmentModal() : ''}
      `;

      lucide.createIcons();

      // Post-render updates
      setTimeout(() => {
        if (state.activeTab === 'history') {
          updateHistoryList();
          document.getElementById('startDate')?.addEventListener('change', updateHistoryList);
          document.getElementById('endDate')?.addEventListener('change', updateHistoryList);
          document.getElementById('searchKeyword')?.addEventListener('input', updateHistoryList);
        }
        if (state.activeTab === 'stats') updateStatsContent();
        if (state.activeTab === 'goal') {
          filterMemos();
          updateEventList();
        }
        if (state.activeTab === 'invest') {
          updateInvestMemoList();
        }
        if (state.showSettings) updateCategoryList();
      }, 0);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
</body>
</html>
